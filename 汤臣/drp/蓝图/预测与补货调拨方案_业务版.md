# 预测与补货/调拨方案（业务版）

## 1. 背景与目标（一页读懂）
- **痛点**：当前 RDC 拆分预测误差偏高、方向上普遍高估，导致库存占用大；周内波动未被消化，出现一边缺货一边堆货。
- **目标**：
  1) 降低整体预测误差（wMAPE）与波动；  
  2) 用统一口径生成**目标库存**与**补货点（ROP）**，减少缺货与旧批积压；  
  3) 用标准批次/止拨/装车规则，生成**可执行的调拨计划**。
- **范围**：A.A 品类，四个物理仓（珠海/北京/成都/昆山），按**周频**运行、**日更**决策。

---

## 2. 方案结论（给业务看的要点）
- **预测方式**：AI 输出多种预测方法，业务人工复核确认；默认推荐 **MA（月→周均分）** 方法
- **核心逻辑**：
  - **目标库存（日）** = 周转库存（日）+ 安全库存（日），每日自动折减
  - **补货点 ROP（日）** = 净需求 × 提前期 + 安全库存（日），每日重算
  - **触发条件**：库存水位（可用 + 在途）< ROP(日)
  - **补货量**：理论缺口 = 目标库存（日）− 库存水位
- **分配规则**：
  - **止拨保护**：调出仓优先保留自身止拨阈值（如1周周转 + 安全库存）
  - **批次分配**：先进先出 + 按缺口比例分配
- **运行频率**：周一重算周基准；每日折减并触发补货

---

## 3. 业务流程（从预测到调拨，一张图）

```mermaid
graph LR
  A["周一自动重算：周需求预测"] --> A2["汇总净需求 = 周预测 + 代发"]
  A2 --> B["计算周转库存（周基准） = 净需求 × (评审 + 提前)"]
  A --> C["计算安全库存（周基准） = z × σ_PP(周)"]
  B --> D["目标库存（周基准） = 周转 + 安全"]
  C --> D
  D --> E["每日折减：剩余评审周数 → 周转库存（日），安全库存沿用周基准"]
  E --> F["计算 ROP(日) = 净需求 × 提前期 + 安全库存（日）"]
  F --> G["每日巡检：在库/在途/可用库存 → 库存水位"]
  G -->|"若 库存水位 < ROP(日)"| H["触发补货：理论补货量 = 目标库存（日） - 库存水位"]
  H --> I["止拨校验：出仓可分配量 = max(0, 在库 - 止拨阈值)"]
  I --> J["取整与合单：包装/起订量/托盘、线路合并"]
  J --> K["生成补货计划（SKU×仓×数量×到达日）"]
  K --> L["批次池：可用批次汇总（含组织属性）"]
  L --> M["按缺口比例分配 + 先进先出"]
  M --> N["生成调拨计划（SKU×批次×调出/入）"]
  N --> O["发运 & 到货回写"]
```

> **频率**：周一重算“周预测/安全库存/目标库存/ROP”；日日巡检在库/在途/库存水位、触发补货与调拨；晚间可批量固化计划版。

---

## 4. 核心指标计算口径
### 4.1 需求预测
- **周需求预测**：AI 输出，人工确认。推荐方法：**MA（月→周均分）**（3个月均值 → 4个完整自然周均分）
- **净需求**：`净需求 = MAX(0, 周需求预测 + 代发需求)`
  - 代发需求 = 代出量 - 代入量（可能为负）

### 4.2 库存目标计算
- **周转库存（周基准）**：`周转库存 = 净需求 × (评审周期 + 提前期)`
  - 示例：净需求 1000件，评审周期 1周，提前期 0.4周 → 周转库存 = 1000 × 1.4 = 1400件
- **周转库存（日）**：`周转库存（日）= 净需求 × (剩余评审周数 + 提前期)`
  - 剩余评审周数 = 剩余自然日 / 7（周一=1，周四≈0.43）
- **安全库存（周基准）**：`SS = z × σ_PP(周)`
  - z值：95%服务水平 → 1.65，90% → 1.28
  - σ_PP：保护期内预测误差标准差
- **安全库存（日）**：= 安全库存（周基准），周内不变
- **目标库存（日）**：`目标库存（日）= 周转库存（日）+ 安全库存（日）`
- **ROP（日）**：`ROP(日) = 净需求 × 提前期 + 安全库存（日）`

### 4.3 补货触发与分配
- **库存水位**：`库存水位 = 可用库存 + 在途库存`
  - 可用库存：从即时库存表中获取
  - 在途库存：调拨单明细中单据状态='待收货'的数量
- **触发条件**：`库存水位 < ROP(日)`
- **理论缺口**：`理论缺口 = MAX(0, 目标库存（日）− 库存水位)`
- **止拨后可分配量**：`可分配量 = MAX(0, 调出仓即时库存 − 止拨阈值)`
  - 止拨阈值示例：1周周转库存 + 安全库存
- **建议补货量**：`建议补货量 = MIN(理论缺口, 止拨后可分配量)`
- **批次分配**：先进先出（FIFO）+ 按缺口比例分配 + 整托优先

---

## 5. 数据产出（业务看得到什么）
- **目标库存表**：单表承载周基准 + 日折减字段；周一生成周基准字段（归属组织、SKU、物理仓、周期起止、周需求预测、代发需求、净需求、周转库存〈周基准〉、安全库存〈周基准〉、目标库存〈周基准〉、提前期、ROP〈周基准〉），每日巡检更新/追加对应日折减字段（巡检日期、剩余评审周数、周转库存〈日〉、安全库存〈日〉、目标库存〈日〉、ROP〈日〉、数据版本、跨月周标记）  
- **补货计划（日报）**：归属组织、SKU、物理仓、在库库存、在途库存、可用库存、库存水位、触发判定（基于 ROP〈日〉）、理论/实际补货量、预计到达日、备注（触发原因）  
- **调拨计划（日报）**：SKU、批次、调出/调入逻辑仓、数量、入库日/到期日、取整/裁剪说明、ETA 到达；线路/车次字段暂未启用  
- **例外清单**：止拨限制导致未满足的 RDC 缺口、需人工确认的“股份仓批次”

---

## 6. 表结构（核心业务表）

### 6.1 目标库存表（周基准 + 日折减）
| 字段 | 含义 |
|---|---|
| record_id | 周基准/日折减记录唯一编号 |
| 归属组织 | 逻辑仓归属组织（需求预测源表/逻辑仓档案提供） |
| sku / 物理仓 | 商品与仓 |
| 周期起/止 | 周基准对应的自然周起止（周一至周日，跨月周照常生成） |
| 跨月周标记 | Y/N；若 Y 则表示自然周跨越两个月，月度核算按日拆分 |
| 巡检日期 | NULL 表示周基准行；有值表示对应日折减行 |
| 周需求预测 | AI 输出多方案→人工确认的本周预测量 |
| 代发需求 | 下游代发或承诺订单占用量（来自“代发需求周汇总表”，按归属组织×逻辑仓聚合） |
| 净需求 | 周需求预测 + 代发需求，用于计算周转库存（周/日） |
| 剩余评审周数 | 周基准 = 评审周期（例 1.0）；日折减 = 剩余自然日 / 7 |
| 周转库存（周基准） | 净需求 × (评审 + 提前) |
| 周转库存（日） | 净需求 × (剩余评审周数 + 提前期)，周基准行可与周转库存（周基准）相同 |
| 安全库存（周基准） | z × σ_PP(周) |
| 安全库存（日） | 与周基准相同（= 安全库存〈周基准〉），周内不随剩余天数变化 |
| 目标库存（周基准） | 周转库存（周基准） + 安全库存（周基准） |
| 目标库存（日） | 周转库存（日） + 安全库存（日） |
| 提前期 | 配置的运输提前期（周） |
| 提前期库存 | 净需求 × 提前期 |
| ROP（周基准） | 提前期库存 + 安全库存（周基准） |
| ROP（日） | 提前期库存 + 安全库存（日） |
| 数据版本 | 生成批次/时间戳，用于识别最新口径 |

### 6.2 补货计划表（周目标 + 日触发）
| 字段 | 含义 |
|---|---|
| request_id | 补货请求号 |
| record_id | 关联目标库存表主键 |
| 归属组织 | 逻辑仓归属组织 |
| sku / 物理仓 | 商品与仓 |
| 巡检日期 | 日巡检日期（同一周可多条） |
| 即时库存 | 在库现货库存（含锁定状态需说明） |
| 在途库存 | 已发未到或在途在制数量 |
| 可用库存 | 在库库存 − 预分配量（含跨仓预占、订单锁定） |
| 库存水位 | 可用库存 + 在途库存 |
| ROP（日） | 同目标库存表（日折减） |
| 目标库存（日） | 同目标库存表（日折减） |
| 理论缺口 | max(0, 目标库存（日） − 库存水位) |
| 止拨后可分配量 | 出仓在库 − 止拨阈值（<0 则 0） |
| 建议补货量 | min(理论缺口, 止拨后可分配量) |
| 实际补货量 | 考虑取整/线路限制后的最终数量 |
| 触发状态/原因 | 触发/未触发及对应原因说明 |
| 预计到达 | ETA（天/日期） |
| 备注 | 例外说明、人工调整记录 |

### 6.3 调拨建议单（最终调拨计划）
| 字段 | 含义 |
|---|---|
| transfer_id / line_id | 调拨单/行 |
| request_id | 关联补货请求 |
| sku / 批次 | 商品与批次（含入库日/到期日） |
| 调出逻辑仓 | 批次所在逻辑仓（可用批次池表中的逻辑仓） |
| 调入逻辑仓 | 根据“归属组织/物理仓 + 调出逻辑仓”在《调出调入仓匹配关系表》查询到的调入逻辑仓 |
| 止拨后可分配量 | 出仓在库 − 止拨阈值（<0 则 0） |
| 计划数量 | 由缺口与可分配量决定 |
| 取整后数量 | 按包装/起订量/托盘取整 |
| 线路/车次（预留） | 当前无车次规划，待运输排程接入后启用 |
| 体积/重量 | 合单与超体限制 |
| ETA | 预计到达 |
| 备注 | 取整/裁剪说明、例外原因 |

> **说明**：需求预测表、代发需求周汇总表、可用批次池表、即时库存表、销售明细表、调拨单明细表等中间层表和源数据表的完整字段定义详见下方"6.4 字段取值清单"。

---


### 6.4 字段取值清单（完整数据字典）
| 表名 | 字段名 | 数据类型 | 字段依赖 | 计算表达式 | 取值/来源 | 备注 |
|---|---|---|---|---|---|---|
| 商品资料管理表 | 商品长编码 | 字符串 | 初始化 |  | 商品长编码 | 主键，与SKU对应 |
| 商品资料管理表 | 体积（立方米）(WMS) | 数值 | 初始化 |  | 商品体积 | 单位：立方米 |
| 商品资料管理表 | 商品名称 | 字符串 | 初始化 |  | 商品名称 | 与商品长编码对应 |
| 商品资料管理表 | 商品类型 | 字符串 | 初始化 |  | 商品类型 | 如产品 |
| 商品资料管理表 | 商品剂型 | 字符串 | 初始化 |  | 商品剂型 | 如粉剂、片剂 |
| 商品资料管理表 | 规格 | 字符串 | 初始化 |  | 商品规格 | 如1g/袋 |
| 商品资料管理表 | 单位 | 字符串 | 初始化 |  | 商品单位 | 如袋、盒 |
| 商品资料管理表 | 装箱数 | 数值 | 初始化 |  | 装箱数量 | 用于取整计算 |
| 商品资料管理表 | 珠海仓码托数 | 数值 | 初始化 |  | 珠海仓码托数 | 托盘数量 |
| 逻辑仓管理表 | 仓库编码 | 字符串 | 初始化 |  | 逻辑仓编码 | 主键 |
| 逻辑仓管理表 | 仓库名称 | 字符串 | 初始化 |  | 逻辑仓名称 | 与仓库编码对应 |
| 逻辑仓管理表 | Eas仓库ID | 字符串 | 初始化 |  | EAS系统仓库ID |  |
| 逻辑仓管理表 | 仓库属性 | 字符串 | 初始化 |  | 仓库属性 | 如产成品 |
| 逻辑仓管理表 | 仓库分类 | 字符串 | 初始化 |  | 仓库分类 | 如逻辑仓 |
| 逻辑仓管理表 | 仓库类型 | 字符串 | 初始化 |  | 仓库类型 | 如TCBJ-B仓 |
| 逻辑仓管理表 | 仓库状态 | 字符串 | 初始化 |  | 仓库状态 | 如有效 |
| 逻辑仓管理表 | 仓库品质 | 字符串 | 初始化 |  | 仓库品质 | 如合格、待检 |
| 逻辑仓管理表 | 所属物理仓 | 字符串 | 初始化 |  | 所属物理仓名称 | 与物理仓主数据校验 |
| 逻辑仓管理表 | 库存组织 | 字符串 | 初始化 |  | 库存组织 | 归属组织 |
| 逻辑仓管理表 | 线上/线下 | 字符串 | 初始化 |  | 线上/线下标识 |  |
| 逻辑仓管理表 | 默认退货仓 | 字符串 | 初始化 |  | 默认退货仓标识 | 是/否 |
| 逻辑仓管理表 | 近效期调入仓 | 字符串 | 初始化 |  | 近效期调入仓 |  |
| 逻辑仓管理表 | 虚拟逻辑仓 | 字符串 | 初始化 |  | 虚拟逻辑仓标识 | 是/否 |
| 逻辑仓管理表 | 是否BC共仓 | 字符串 | 初始化 |  | BC共仓标识 | 是/否 |
| 逻辑仓管理表 | 转合格入库仓 | 字符串 | 初始化 |  | 转合格入库仓标识 | 是/否 |
| 逻辑仓管理表 | 备注 | 字符串 | 初始化 |  | 备注信息 |  |
| 逻辑仓管理表 | 创建人 | 字符串 | 初始化 |  | 创建人 |  |
| 逻辑仓管理表 | 创建时间 | 时间戳 | 初始化 |  | 创建时间 |  |
| 逻辑仓管理表 | 更新时间 | 时间戳 | 初始化 |  | 更新时间 |  |
| 逻辑仓管理表 | 更新人 | 字符串 | 初始化 |  | 更新人 |  |
| 逻辑仓管理表 | 计费组织 | 字符串 | 初始化 |  | 计费组织编码 | 财务/成本归属 |
| 逻辑仓管理表 | 计费组织类型 | 字符串 | 初始化 |  | 计费组织类型 |  |
| 逻辑仓管理表 | 计费组织名称 | 字符串 | 初始化 |  | 计费组织名称 | 与计费组织编码对应 |
| 逻辑仓管理表 | 计费组织id | 字符串 | 初始化 |  | 计费组织ID |  |
| 物理仓管理表 | 序号 | 数值 | 初始化 |  | 记录序号 | 主键 |
| 物理仓管理表 | 仓库编码 | 字符串 | 初始化 |  | 物理仓编码 | 主键 |
| 物理仓管理表 | 仓库简码 | 字符串 | 初始化 |  | 物理仓简码 | 与仓库编码对应 |
| 物理仓管理表 | 仓库名称 | 字符串 | 初始化 |  | 物理仓名称 | 与仓库编码对应 |
| 物理仓管理表 | 仓库状态 | 字符串 | 初始化 |  | 仓库状态 | 如有效 |
| 物理仓管理表 | 是否物流仓 | 字符串 | 初始化 |  | 物流仓标识 | 是/否 |
| 物理仓管理表 | 物流标记码 | 字符串 | 初始化 |  | 物流标记码 |  |
| 物理仓管理表 | 仓库类型 | 字符串 | 初始化 |  | 仓库类型 | 如物理仓 |
| 物理仓管理表 | 是否RDC仓 | 字符串 | 初始化 |  | RDC仓标识 | 是/否 |
| 物理仓管理表 | SAP仓库ID | 字符串 | 初始化 |  | SAP系统仓库ID |  |
| 物理仓管理表 | 仓库地址 | 字符串 | 初始化 |  | 仓库地址 |  |
| 物理仓管理表 | 操作 | 字符串 | 初始化 |  | 操作标识 |  |
| 供货仓管理表 | 仓库名称 | 字符串 | 初始化 |  | 供货仓名称 | 主键 |
| 供货仓管理表 | 仓库编码 | 字符串 | 初始化 |  | 供货仓编码 | 与仓库名称对应 |
| 即时库存表 | 商品长编码 | 字符串 | 初始化 |  | 商品长编码 | 与SKU对应 |
| 即时库存表 | 商品名称 | 字符串 | 初始化 |  | 商品名称 | 与商品长编码对应 |
| 即时库存表 | 批次 | 字符串 | 初始化 |  | 批次号 | WMS批次号 |
| 即时库存表 | 仓库类型 | 字符串 | 初始化 |  | 仓库类型 | 如逻辑仓、物理仓 |
| 即时库存表 | 仓库编码 | 字符串 | 初始化 |  | 仓库编码 | 与仓库主数据校验 |
| 即时库存表 | 仓库名称 | 字符串 | 初始化 |  | 仓库名称 | 与仓库编码对应 |
| 即时库存表 | 库存组织 | 字符串 | 初始化 |  | 库存组织 | 计费组织 |
| 即时库存表 | 即时库存 | 数值 | 初始化 |  | 即时库存数量 | 单位：PCS |
| 即时库存表 | 可用库存 | 数值 | 初始化 |  | 可用库存数量 | 单位：PCS |
| 即时库存表 | 预占库存 | 数值 | 初始化 |  | 预占库存数量 | 单位：PCS |
| 即时库存表 | 锁定库存 | 数值 | 初始化 |  | 锁定库存数量 | 单位：PCS |
| 即时库存表 | 待收数 | 数值 | 初始化 |  | 待收数量 | 单位：PCS |
| 即时库存表 | 在途库存 | 数值 | 初始化 |  | 在途库存数量 | 单位：PCS |
| 即时库存表 | 生产日期 | 日期 | 初始化 |  | 生产日期 | 批次属性 |
| 即时库存表 | 到期日期 | 日期 | 初始化 |  | 到期日期 | 批次属性 |
| 即时库存表 | 销售预占 | 数值 | 初始化 |  | 销售预占数量 | 单位：PCS |
| 即时库存表 | 创建时间 | 时间戳 | 初始化 |  | 记录创建时间 |  |
| 即时库存表 | 更新时间 | 时间戳 | 初始化 |  | 记录更新时间 |  |
| 即时库存表 | 更新人 | 字符串 | 初始化 |  | 更新人 |  |
| 销售明细表 | 渠道订单号 | 字符串 | 初始化 |  | 渠道订单号 | 外部订单号 |
| 销售明细表 | 内部销售订单号 | 字符串 | 初始化 |  | 内部销售订单号 | 系统内部订单号 |
| 销售明细表 | 出库通知单号 | 字符串 | 初始化 |  | 出库通知单号 | WMS出库单号 |
| 销售明细表 | 订单状态 | 字符串 | 初始化 |  | 订单状态 | 如待审核、已发货等 |
| 销售明细表 | 订单来源 | 字符串 | 初始化 |  | 订单来源 | 如线上、线下 |
| 销售明细表 | 订单类型 | 字符串 | 初始化 |  | 订单类型 | 如普通订单、代发订单 |
| 销售明细表 | 库存组织编码 | 字符串 | 初始化 |  | 库存组织编码 | 与库存组织名称对应 |
| 销售明细表 | 库存组织名称 | 字符串 | 初始化 |  | 库存组织名称 | 归属组织 |
| 销售明细表 | 商品编码 | 字符串 | 初始化 |  | 商品编码 | 与商品主数据校验 |
| 销售明细表 | 商品名称 | 字符串 | 初始化 |  | 商品名称 | 与商品编码对应 |
| 销售明细表 | 供货仓 | 字符串 | 初始化 |  | 供货仓 | 供货仓名称 |
| 销售明细表 | 预计发货物理仓 | 字符串 | 销售明细表.供货仓, 供货仓-预计发货物理仓关系表.预计发货物理仓名称 | 通过供货仓匹配 | 根据供货仓在供货仓-预计发货物理仓关系表中匹配 | 预计发货物理仓名称 |
| 销售明细表 | 实际发货物理仓 | 字符串 | 初始化 |  | 实际发货物理仓 | 实际发货仓库 |
| 销售明细表 | 批次 | 字符串 | 初始化 |  | 批次 | 发货批次号 |
| 销售明细表 | 数量 | 数值 | 初始化 |  | 数量 | 订单数量，单位：PCS |
| 销售明细表 | 总体积（m³） | 数值 | 初始化 |  | 总体积 | 单位：立方米 |
| 销售明细表 | 重量（kg） | 数值 | 初始化 |  | 重量 | 单位：千克 |
| 销售明细表 | 已出库数量 | 数值 | 初始化 |  | 已出库数量 | 实际出库数量，单位：PCS |
| 销售明细表 | 实际发货逻辑仓 | 字符串 | 初始化 |  | 实际发货逻辑仓 | 逻辑仓名称 |
| 销售明细表 | 创建时间 | 时间戳 | 初始化 |  | 创建时间 | 订单创建时间 |
| 销售明细表 | 发货时间 | 时间戳 | 初始化 |  | 订单发货时间 | WMS出库完成时间 |
| 销售明细表 | 是否旧批次 | 字符串(Y/N) | 销售明细表.批次, 销售明细表.发货时间 | IF(批次所属月份 ≤ 发货月份 − 3个月, 'Y', 'N') | 规则判定 | 批次编码示例：202504F→2025-04；例：发货10-18，则8月以前为旧批次 |
| 调出调入仓匹配关系表 | 调出仓编码 | 字符串 | 逻辑仓管理表.仓库编码 |  | 调出逻辑仓编码 | 与逻辑仓主数据校验 |
| 调出调入仓匹配关系表 | 调出仓 | 字符串 | 逻辑仓管理表.仓库名称 |  | 调出逻辑仓名称 | 与调出仓编码对应 |
| 调出调入仓匹配关系表 | 调入物理仓 | 字符串 | 物理仓管理表.仓库名称 |  | 调入物理仓名称 | 与物理仓主数据校验 |
| 调出调入仓匹配关系表 | 调入仓编码 | 字符串 | 逻辑仓管理表.仓库编码 |  | 调入逻辑仓编码 | 与逻辑仓主数据校验 |
| 调出调入仓匹配关系表 | 调入仓 | 字符串 | 逻辑仓管理表.仓库名称 |  | 调入逻辑仓名称 | 与调入仓编码对应 |
| 服务水平-Z值映射表 | 服务水平 | 字符串 | 初始化 |  | 服务水平百分比 | 如95.00% |
| 服务水平-Z值映射表 | Z值 | 数值 | 初始化 |  | 服务水平对应的Z值 | 用于安全库存计算 |
| 服务水平配置表 | SKU | 字符串 | 商品资料管理表.商品长编码 |  | 商品编码 | 与商品主数据校验 |
| 服务水平配置表 | 商品名称 | 字符串 | 商品资料管理表.商品名称 |  | 商品名称 | 与SKU对应 |
| 服务水平配置表 | 物理仓 | 字符串 | 物理仓管理表.仓库名称 |  | 物理仓名称 | 与物理仓主数据校验 |
| 服务水平配置表 | 服务水平 | 字符串 | 服务水平-Z值映射表.服务水平 |  | 服务水平百分比 | 如95.00% |
| 供货仓-预计发货物理仓关系表 | 供货仓名称 | 字符串 | 供货仓管理表.仓库名称 |  | 供货仓名称 | 与供货仓编码对应 |
| 供货仓-预计发货物理仓关系表 | 供货仓编码 | 字符串 | 供货仓管理表.仓库编码 |  | 供货仓编码 | 与供货仓主数据校验 |
| 供货仓-预计发货物理仓关系表 | 预计发货物理仓名称 | 字符串 | 物理仓管理表.仓库名称 |  | 预计发货物理仓名称 | 与物理仓主数据校验 |
| 供货仓-预计发货物理仓关系表 | 预计发货物理仓编码 | 字符串 | 物理仓管理表.仓库编码 |  | 预计发货物理仓编码 | 与物理仓主数据校验 |
| 需求预测表 | 周次 | 字符串 | 调度任务 |  | 自然周标识 | 如2025-W08 |
| 需求预测表 | 开始时间 | 日期 | 调度任务 |  | 周起始日期 | 周一 |
| 需求预测表 | 结束时间 | 日期 | 调度任务 |  | 周结束日期 | 周日 |
| 需求预测表 | SKU编码 | 字符串 | 商品资料管理表.商品长编码 |  | 商品编码 | 与商品主数据校验 |
| 需求预测表 | SKU名称 | 字符串 | 商品资料管理表.商品名称 |  | 商品名称 | 与SKU编码对应 |
| 需求预测表 | 归属组织 | 字符串 | 逻辑仓管理表.库存组织 |  | 逻辑仓归属组织 | 与逻辑仓档案校验 |
| 需求预测表 | 预计发货物理仓 | 字符串 | 物理仓管理表.仓库名称 |  | 预测对应的物理仓 | 与仓库主数据校验 |
| 需求预测表 | 预计发货仓销售量 | 数值 | 销售明细表.已出库数量 |  | 成都仓实际销量 | 用于校验 |
| 需求预测表 | 需求预测 | 数值 | AI模型 |  | AI输出的周需求预测值 | 单位：PCS/周 |
| 需求预测表 | 预测方法 | 字符串 | AI模型 |  | AI预测方法标识 | 如MA、ARIMA、LSTM等 |
| 需求预测表 | 预测误差绝对值 | 数值 | 需求预测表.预计发货仓销售量, 需求预测表.需求预测 | abs(预计发货仓销售量 - 需求预测) | \|实际销量 - 预测值\| | 用于误差分析 |
| 需求预测表 | 预测误差 | 数值 | 需求预测表.预计发货仓销售量, 需求预测表.需求预测 | 预计发货仓销售量 - 需求预测 | 实际销量 - 预测值 | 正负值 |
| 需求预测表 | 预测误差标准差（σ_PP） | 数值 | 需求预测表.预测误差 | stdev(预测误差) | 保护期内预测误差的标准差 | 用于安全库存计算 |
| 需求预测表 | 跨月周标记 | 字符串(Y/N) | 周次 | 判断周是否跨月 | 日历拆分逻辑 | 标记自然周是否跨月 |
| 代发需求周汇总表 | 归属组织 | 字符串 | 销售明细表.库存组织名称 |  | 取自销售订单明细中的销售组织字段 | 与 SKU、物理仓、自然周组合唯一 |
| 代发需求周汇总表 | SKU | 字符串 | 销售明细表.商品编码 |  | 销售/代发订单明细聚合 | 与归属组织、物理仓、自然周组合唯一 |
| 代发需求周汇总表 | 物理仓 | 字符串 | 销售明细表.预计发货物理仓 |  | 预计发货的物理仓 | 与归属组织、SKU、自然周组合唯一 |
| 代发需求周汇总表 | 周期起 | 日期 | 销售明细表.创建时间 |  | 依据销售订单明细"创建时间"映射的自然周周一 |  |
| 代发需求周汇总表 | 周期止 | 日期 | 销售明细表.创建时间 |  | 依据销售订单明细"创建时间"映射的自然周周日 |  |
| 代发需求周汇总表 | 方向 | 枚举 | 销售明细表.预计发货物理仓, 销售明细表.实际发货物理仓 | 比较预计发货物理仓与实际发货物理仓判断 | 本仓代发他仓 / 他仓代发本仓 | 表示代发方向 |
| 代发需求周汇总表 | 对端组织 | 字符串 | 销售明细表.库存组织名称 |  | 对端销售组织/公司 | 对不到时可空 |
| 代发需求周汇总表 | 对端仓 | 字符串 | 销售明细表.实际发货物理仓 |  | 实际发货的物理仓 | 对不到时可空 |
| 代发需求周汇总表 | 代出量 | 数值 | 销售明细表.已出库数量 | sum(已出库数量) WHERE 方向='本仓代发他仓' | 本仓→他仓代发量（正向字段） | 单位：PCS/周 |
| 代发需求周汇总表 | 代入量 | 数值 | 销售明细表.已出库数量 | sum(已出库数量) WHERE 方向='他仓代发本仓' | 他仓→本仓代发量 | 单位：PCS/周 |
| 代发需求周汇总表 | 净代发量 | 数值 | 代发需求周汇总表.代出量, 代发需求周汇总表.代入量 | 代出量 - 代入量 | 代出量 − 代入量 | 用于净需求调整 |
| 代发需求周汇总表 | 源订单行数 | 整数 | 销售明细表 | count(*) | 聚合时记录的订单行数 | 便于追溯与稽核 |
| 代发需求周汇总表 | 数据版本 | 时间戳 | 调度任务 |  | 调度批次号/生成时间 | 支持重算对比 |
| 代发需求周汇总表 | 最后更新时间 | 时间戳 | 调度任务 |  | 调度落表时间 | 监控数据刷新 |
| 目标库存表 | record_id | 字符串 | 调度任务 |  | Agent 生成唯一 ID（UUID） | 周基准、日折减共用主键 |
| 目标库存表 | 归属组织 | 字符串 | 需求预测表.归属组织 |  | 需求预测源表字段；校验逻辑仓档案 | 与 SKU、物理仓组合唯一 |
| 目标库存表 | SKU | 字符串 | 需求预测表.SKU编码 |  | 需求预测源表（AI 输出/人工确认）校验商品主数据 | 与仓组合唯一 |
| 目标库存表 | 物理仓 | 字符串 | 需求预测表.预计发货物理仓 |  | 需求预测源表校验仓库主数据 | 与 SKU 组合唯一 |
| 目标库存表 | 周期起/止 | 日期 | 调度任务 |  | 调度任务按自然周写入 | 周一至周日，跨月周照常生成 |
| 目标库存表 | 跨月周标记 | 字符串(Y/N) | 需求预测表.跨月周标记 |  | 日历拆分逻辑 | 标记自然周是否跨月 |
| 目标库存表 | 巡检日期 | 日期/NULL | 调度任务 |  | 周基准写 NULL；日折减写调度日期 | 支持同周多条 |
| 目标库存表 | 周需求预测 | 数值 | 需求预测表.需求预测 |  | AI 模型输出+人工确认 | 单位：PCS/周 |
| 目标库存表 | 代发需求 | 数值 | 代发需求周汇总表.净代发量 |  | 中间层：代发需求周汇总表 | 同口径周聚合 |
| 目标库存表 | 净需求 | 数值 | 目标库存表.周需求预测, 目标库存表.代发需求 | MAX(0, 周需求预测 + 代发需求) | 计算：MAX(0, 周需求预测 + 代发需求) | 结果供后续库存计算 |
| 目标库存表 | 评审周期 | 小数 | 补货参数配置表.评审周期（天） | 评审周期（天）/ 7 | 配置表转换为周 | 单位：周 |
| 目标库存表 | 剩余自然日 | 整数 | 调度任务 | 周期止 - 巡检日期 | 计算剩余天数 | 用于日折减 |
| 目标库存表 | 剩余评审周数 | 小数 | 目标库存表.剩余自然日 | 剩余自然日 / 7 | 计算：剩余自然日 / 7 | 周基准=评审周期; 日折减按当日更新 |
| 目标库存表 | 周转库存（周基准） | 数值 | 目标库存表.净需求, 目标库存表.评审周期, 目标库存表.提前期 | 净需求 × (评审周期 + 提前期) | 计算：净需求 × (评审周期 + 提前期) | 单位：PCS |
| 目标库存表 | 周转库存（日） | 数值 | 目标库存表.净需求, 目标库存表.剩余评审周数, 目标库存表.提前期 | 净需求 × (剩余评审周数 + 提前期) | 计算：净需求 × (剩余评审周数 + 提前期) | 日折减使用 |
| 目标库存表 | 安全库存（周基准） | 数值 | 服务水平-Z值映射表.Z值, 需求预测表.预测误差标准差（σ_PP） | z × σ_PP(周) | 计算：z × σ_PP(周) | z 取自服务水平配置 |
| 目标库存表 | 安全库存（日） | 数值 | 目标库存表.安全库存（周基准） | 安全库存（周基准） | 复制周基准值 | 周内不变 |
| 目标库存表 | 目标库存（周基准） | 数值 | 目标库存表.周转库存（周基准）, 目标库存表.安全库存（周基准） | 周转库存（周基准） + 安全库存（周基准） | 计算：周转库存（周基准） + 安全库存（周基准） |  |
| 目标库存表 | 目标库存（日） | 数值 | 目标库存表.周转库存（日）, 目标库存表.安全库存（日） | 周转库存（日） + 安全库存（日） | 计算：周转库存（日） + 安全库存（日） |  |
| 目标库存表 | 提前期 | 小数 | 补货参数配置表.提前期（天） | 提前期（天）/ 7 | 配置表转换为周 | 单位：周 |
| 目标库存表 | 提前期库存 | 数值 | 目标库存表.净需求, 目标库存表.提前期 | 净需求 × 提前期 | 计算：净需求 × 提前期 | 使用周单位 |
| 目标库存表 | ROP（周基准） | 数值 | 目标库存表.提前期库存, 目标库存表.安全库存（周基准） | 提前期库存 + 安全库存（周基准） | 计算：提前期库存 + 安全库存（周基准） |  |
| 目标库存表 | ROP（日） | 数值 | 目标库存表.提前期库存, 目标库存表.安全库存（日） | 提前期库存 + 安全库存（日） | 计算：提前期库存 + 安全库存（日） | 周内不变 |
| 目标库存表 | 数据版本 | 时间戳 | 调度任务 |  | 调度批次号/生成时间 | 用于区分多次重算 |
| 可用批次池表 | batch_pool_id | 字符串 | 调度任务 |  | Agent 生成批次池记录号 |  |
| 可用批次池表 | SKU | 字符串 | 目标库存表.SKU |  | 引用目标库存表的 SKU 字段 |  |
| 可用批次池表 | 归属组织 | 字符串 | 目标库存表.归属组织 |  | 引用目标库存表的归属组织字段 |  |
| 可用批次池表 | 物理仓 | 字符串 | 目标库存表.物理仓 |  | 引用目标库存表的物理仓字段 |  |
| 可用批次池表 | 逻辑仓 | 字符串 | 即时库存表.逻辑仓 |  | 即时库存表批次记录中的逻辑仓（校验逻辑仓档案过滤结果） |  |
| 可用批次池表 | 批次号 | 字符串 | 即时库存表.批次 |  | 通过SKU+物理仓在即时库存表中匹配逻辑仓，然后获取该逻辑仓下的所有批次号 |  |
| 可用批次池表 | 批次库存数量 | 数值 | 即时库存表.即时库存 |  | 即时库存表按 归属组织×物理仓×SKU×逻辑仓 读取的批次库存数量 | 单位：PCS |
| 可用批次池表 | 可使用数量 | 数值 | 可用批次池表.批次库存数量, 可用批次池表.计费组织, 可用批次池表.归属组织 | IF(计费组织=归属组织, 批次库存数量, 人工确认值) | 计费组织=归属组织时等于批次库存数量；计费组织为股份等上级组织时由人工确认填写 | 单位：PCS |
| 可用批次池表 | 计费组织 | 字符串 | 逻辑仓管理表.计费组织 |  | 逻辑仓档案字段"计费组织"（判定是否需人工确认） |  |
| 可用批次池表 | 数据版本 | 时间戳 | 调度任务 |  | 批次池生成时间 |  |
| 补货计划表 | request_id | 字符串 | 调度任务 |  | Agent 生成唯一 ID | 对应一次补货触发 |
| 补货计划表 | record_id | 字符串 | 目标库存表.record_id |  | 引用目标库存表 | 对应周目标记录 |
| 补货计划表 | 归属组织 | 字符串 | 目标库存表.归属组织 |  | 引用目标库存表 | 逻辑仓聚合维度 |
| 补货计划表 | SKU | 字符串 | 目标库存表.SKU |  | 继承自目标库存表 |  |
| 补货计划表 | 物理仓 | 字符串 | 目标库存表.物理仓 |  | 继承自目标库存表 |  |
| 补货计划表 | 巡检日期 | 日期 | 调度任务 |  | 调度任务日期 | 每日可多条 |
| 补货计划表 | 即时库存 | 数值 | 即时库存表.即时库存 | sum(即时库存) 按归属组织×物理仓聚合 | 按归属组织×物理仓聚合，并仅保留逻辑仓档案过滤后的逻辑仓（仓库品质=合格、计费组织=归属组织、仓库分类=逻辑仓） | 单位：PCS，含锁定说明 |
| 补货计划表 | 在途库存 | 数值 | 调拨单明细表.已出库数量 | sum(已出库数量) WHERE 单据状态='待收货' 按归属组织×物理仓聚合 | 在途明细，按归属组织×物理仓聚合 | 单位：PCS，未到货数量 |
| 补货计划表 | 可用库存 | 数值 | 即时库存表.可用库存 | sum(可用库存) 按归属组织×物理仓聚合 | 按归属组织×物理仓聚合，并仅保留逻辑仓档案过滤后的逻辑仓 | 单位：PCS |
| 补货计划表 | 库存水位 | 数值 | 补货计划表.可用库存, 补货计划表.在途库存 | 可用库存 + 在途库存 | 计算：可用库存 + 在途库存 | 触发比较用 |
| 补货计划表 | ROP（日） | 数值 | 目标库存表.ROP（日） |  | 引用目标库存表 |  |
| 补货计划表 | 目标库存（日） | 数值 | 目标库存表.目标库存（日） |  | 引用目标库存表 |  |
| 补货计划表 | 理论缺口 | 数值 | 补货计划表.目标库存（日）, 补货计划表.库存水位 | max(0, 目标库存（日） − 库存水位) | 计算：max(0, 目标库存（日） − 库存水位) |  |
| 补货计划表 | 止拨后可分配量 | 数值 | 即时库存表.即时库存, 补货参数配置表.止拨阈值 | max(0, 调出仓即时库存 − 止拨阈值) | 计算：max(0, 调出仓即时库存 − 止拨阈值) | 止拨阈值见 7.2 止拨规则 |
| 补货计划表 | 建议补货量 | 数值 | 补货计划表.理论缺口, 补货计划表.止拨后可分配量 | min(理论缺口, 止拨后可分配量) | 计算：min(理论缺口, 止拨后可分配量) | 未取整前 |
| 补货计划表 | 实际补货量 | 数值 | 补货计划表.建议补货量, 商品资料管理表.装箱数 | 按装箱数取整 | 取整/裁剪后结果 | 装车约束后值 |
| 补货计划表 | 触发状态/原因 | 字符串 | 补货计划表.库存水位, 补货计划表.ROP（日） | IF(库存水位 ≤ ROP（日）, '触发', '未触发') | 逻辑判断输出 | 记录触发/未触发及原因 |
| 补货计划表 | 预计到达 | 日期 | 补货参数配置表.提前期（天）, 补货计划表.巡检日期 | 巡检日期 + 提前期（天） | 巡检日期 + 提前期（天） | ETA 估算 |
| 补货计划表 | 备注 | 字符串 | 人工填写 |  | 人工/系统填写 | 例外说明 |
| 调拨建议单 | transfer_id / line_id | 字符串 | 调度任务或OCS系统 |  | Agent 生成或 OCS 返回 | 调拨单及行号 |
| 调拨建议单 | request_id | 字符串 | 补货计划表.request_id |  | 引用补货计划表 | 补货计划表 |
| 调拨建议单 | SKU | 字符串 | 补货计划表.SKU |  | 继承补货计划表 | 补货计划表 |
| 调拨建议单 | 归属组织 | 字符串 | 补货计划表.归属组织 |  | 引用补货计划表 | 补货计划表 |
| 调拨建议单 | 物理仓 | 字符串 | 补货计划表.物理仓 |  | 引用补货计划表 | 补货计划表 |
| 调拨建议单 | 批次 | 字符串 | 可用批次池表.批次号 | 按FIFO选择 | 根据SKU+归属组织+物理仓在可用批次池中按先进先出规则选择批次，可跨批选择 | 含入库日/到期日 |
| 调拨建议单 | 调出逻辑仓 | 字符串 | 可用批次池表.逻辑仓 |  | 直接来自批次池的逻辑仓 |  |
| 调拨建议单 | 调入逻辑仓 | 字符串 | 调出调入仓匹配关系表.调入仓编码 |  | 通过"物理仓 + 调出逻辑仓"在调出调入仓匹配关系表映射得到 |  |
| 调拨建议单 | 止拨后可分配量 | 数值 | 补货计划表.止拨后可分配量 |  | 补货计划表可分配量快照 | 写入调拨前的可用量 |
| 调拨建议单 | 计划数量 | 数值 | 可用批次池表.可使用数量, 补货计划表.理论缺口, 补货计划表.止拨后可分配量, 商品资料管理表.装箱数 | 按缺口比例+FIFO+整托取整 | 按缺口比例在可用批次池中分配，遵循先进先出；按包装/整托取整（若批次=托板则不拆托）；受止拨后可分配量与批次可用量约束（详见 8.1 计算案例）；不含装载裁剪 | 已按装箱/整托口径取整 |
| 调拨建议单 | 取整后数量 | 数值 | 调拨建议单.计划数量 | 计划数量 | 与计划数量一致（计划数量已按整托口径生成，天然为装箱整数倍）；不涉及装载/线路裁剪 | 实际调拨数量 |
| 调拨建议单 | 线路/车次（预留） | 字符串 | 运输系统 |  | 暂无（预留字段） | 运输排程上线后填充 |
| 调拨建议单 | 体积/重量 | 数值 | 商品资料管理表.体积（立方米）(WMS), 调拨建议单.取整后数量 | 商品体积/重量 × 数量 | 计算：商品体积/重量 × 数量 | 装车校验 |
| 调拨建议单 | ETA | 日期 | 补货计划表.预计到达 |  | 运输计划 |  |
| 调拨建议单 | 备注 | 字符串 | 人工填写 |  | 系统+人工填写 | 取整、裁剪、例外说明 |
| 调拨单表 | 调出逻辑仓名称 | 字符串 | 逻辑仓管理表.仓库名称 |  | 与调出逻辑仓编码对应 |  |
| 调拨单表 | *调出逻辑仓编码 | 字符串 | 逻辑仓管理表.仓库编码 |  | 批次所在逻辑仓 | 必填 |
| 调拨单表 | 调入逻辑仓名称 | 字符串 | 逻辑仓管理表.仓库名称 |  | 与调入逻辑仓编码对应 |  |
| 调拨单表 | *调入逻辑仓编码 | 字符串 | 调出调入仓匹配关系表.调入仓编码 |  | 由“归属组织/物理仓 + 调出逻辑仓”映射 | 必填 |
| 调拨单表 | *商品长编码 | 字符串 | 商品资料管理表.商品长编码 |  | 商品编码 | 与商品主数据校验，必填 |
| 调拨单表 | *批次 | 字符串 | 可用批次池表.批次号 |  | 入库日/到期日 | 必填 |
| 调拨单表 | *计划调拨数量 | 数值 | 调拨建议单.取整后数量 |  | 继承调拨建议单 | 单位：PCS，必填 |
| 调拨单表 | 备注 | 字符串 | 人工填写 |  | 系统/人工填写 |  |
| 调拨单表 | 调拨时间 | 时间戳 |  |  |  |  |
| 未分配清单表 | record_id | 字符串 | 调度任务 |  | 未分配记录唯一编号 |  |
| 未分配清单表 | 归属组织 | 字符串 | 逻辑仓管理表.库存组织 |  | 逻辑仓归属组织 |  |
| 未分配清单表 | SKU | 字符串 | 商品资料管理表.商品长编码 |  | 商品编码 | 与商品主数据校验 |
| 未分配清单表 | sku名称 | 字符串 | 商品资料管理表.商品名称 |  | 商品名称 | 与 sku 对应 |
| 未分配清单表 | 批次 | 字符串 | 可用批次池表.批次号 |  | 批次号（可选） |  |
| 未分配清单表 | 调出逻辑仓 | 字符串 | 逻辑仓管理表.仓库名称 |  | 批次所在逻辑仓 |  |
| 未分配清单表 | 原计划数量 | 数值 | 调拨建议单.计划数量 |  | 未裁剪前计划量 | 单位：PCS |
| 未分配清单表 | 未分配数量 | 数值 | 规则计算 | 原计划数量 − 受约束实际分配量 | 残量 | 单位：PCS |
| 未分配清单表 | 未分配原因 | 字符串 | 约束判断 |  | 止拨不足/小于最小拆分量/超 K 限制/托盘不拆/装箱取整残量/其他 |  |
| 未分配清单表 | 约束类型 | 字符串 | 约束判断 |  | 如“最小拆分量”“K 限制”“整托不拆” |  |
| 未分配清单表 | 约束参数 | 字符串 | 参数配置 |  | 如最小拆分=3 箱、K=2、止拨阈值等 |  |
| 未分配清单表 | 备注 | 字符串 | 人工填写 |  | 说明与处理建议（如“下周期优先补齐”） |  |
| 补货参数配置表 | SKU | 字符串 | 商品资料管理表.商品长编码 |  | 商品编码 | 与商品主数据校验 |
| 补货参数配置表 | 商品名称 | 字符串 | 商品资料管理表.商品名称 |  | 商品名称 | 与SKU对应 |
| 补货参数配置表 | 物理仓名称 | 字符串 | 物理仓管理表.仓库名称 |  | 物理仓名称 | 与物理仓编码对应 |
| 补货参数配置表 | 物理仓编码 | 字符串 | 物理仓管理表.仓库编码 |  | 物理仓编码 | 与物理仓主数据校验 |
| 补货参数配置表 | 评审周期（天） | 数值 | 初始化 |  | 评审周期天数 | 单位：天 |
| 补货参数配置表 | 提前期（天） | 数值 | 初始化 |  | 提前期天数 | 单位：天 |
| 补货参数配置表 | 止拨阈值口径 | 字符串 | 初始化 |  | 枚举：自动计算/固定值 | 自动=周转库存（日）+安全库存（日） |
| 补货参数配置表 | 止拨阈值（件） | 数值 | 目标库存表.周转库存（日）, 目标库存表.安全库存（日） | IF(止拨阈值口径='自动计算', 周转库存（日）+安全库存（日）, 固定值) | 计算或配置 | 调出仓止拨保护线 |
| 补货参数配置表 | 是否计入在途 | 字符串(Y/N) | 初始化 | IF(值='Y', 可用库存 + 在途库存, 可用库存) | 参数配置 | 默认Y，决定“库存水位”口径 |
| 补货参数配置表 | 是否使用止拨策略 | 字符串(Y/N) | 初始化 | IF(值='Y', MAX(0, 调出仓即时库存 − 止拨阈值), 调出仓即时库存) | 参数配置 | 默认Y，禁用时不做止拨限制 |
| 调拨策略参数表 | SKU | 字符串 | 商品资料管理表.商品长编码 |  | 商品编码 | 允许为空，表示按仓或全局 |
| 调拨策略参数表 | 物理仓名称 | 字符串 | 物理仓管理表.仓库名称 |  | 物理仓名称 | 与物理仓编码对应，允许为空 |
| 调拨策略参数表 | 物理仓编码 | 字符串 | 物理仓管理表.仓库编码 |  | 物理仓编码 | 允许为空，用于层级覆盖 |
| 调拨策略参数表 | K值（同批次最多去向数） | 整数 | 初始化 |  | 策略参数 | 默认2 |
| 调拨策略参数表 | 最小拆分箱数 | 整数 | 初始化 |  | 策略参数 | 默认3 |
| 调拨策略参数表 | 最大拆分箱数 | 整数 | 初始化 |  | 策略参数 | 0/空为不限制 |
| 调拨策略参数表 | 仅允许最后一批可拆 | 字符串(Y/N) | 初始化 |  | 策略参数 | 默认Y |
| 调拨策略参数表 | 允许拆托 | 字符串(Y/N) | 初始化 |  | 策略参数 | 默认N（整托不拆） |
| 调拨策略参数表 | 跨批最大数 | 整数 | 初始化 |  | 策略参数 | 默认2 |
| 调拨策略参数表 | 比例容差（%） | 小数 | 初始化 |  | 策略参数 | 默认2.0 |
| 调拨策略参数表 | 取整逻辑 | 字符串 | 初始化 | 枚举：向上/向下 | 参数配置 | 默认向上；按包装/托盘倍数取整 |
| 调拨策略参数表 | 生效时间 | 时间戳 | 初始化 |  | 生效开始 |  |
| 调拨策略参数表 | 失效时间 | 时间戳 | 初始化 |  | 生效结束 |  |
| 调拨策略参数表 | 备注 | 字符串 | 人工填写 |  | 说明 |  |
| 物流运费明细表 | 记账日期 | 日期 | 初始化 |  | 记账日期 | 用于财务对账 |
| 物流运费明细表 | 发货日期 | 日期 | 初始化 |  | 实际发货日期 |  |
| 物流运费明细表 | 所属省份 | 字符串 | 初始化 |  | 省份 | 收货省份 |
| 物流运费明细表 | 所属区域 | 字符串 | 初始化 |  | 大区 |  |
| 物流运费明细表 | 区/县 | 字符串 | 初始化 |  | 区县 |  |
| 物流运费明细表 | WMS出库单号 | 字符串 | 初始化 |  | WMS出库单号 |  |
| 物流运费明细表 | EAS订单号 | 字符串 | 初始化 |  | EAS订单号 |  |
| 物流运费明细表 | WMS合单号 | 字符串 | 初始化 |  | WMS合单号 |  |
| 物流运费明细表 | 托运单号 | 字符串 | 初始化 |  | 托运单号 |  |
| 物流运费明细表 | 出库通知单 | 字符串 | 初始化 |  | 出库通知单 |  |
| 物流运费明细表 | 承运商单号 | 字符串 | 初始化 |  | 承运商单号 |  |
| 物流运费明细表 | 出库结果单号 | 字符串 | 初始化 |  | 出库结果单号 |  |
| 物流运费明细表 | 关联业务单号 | 字符串 | 初始化 |  | 关联业务单号 | 订单/调拨单号 |
| 物流运费明细表 | 体积(m³) | 数值 | 初始化 |  | 计费体积 | 单位：立方米 |
| 物流运费明细表 | 重量(KG) | 数值 | 初始化 |  | 计费重量 | 单位：千克 |
| 物流运费明细表 | 累计合并体积(m³) | 数值 | 初始化 |  | 合单计费体积 | 单位：立方米 |
| 物流运费明细表 | 累计合并重量(KG) | 数值 | 初始化 |  | 合单计费重量 | 单位：千克 |
| 物流运费明细表 | 计费方式 | 字符串 | 初始化 |  | 计费口径 | 如重量/体积/件 |
| 物流运费明细表 | 运费合计 | 数值 | 初始化 |  | 运费金额 | 单位：元 |
| 物流运费明细表 | 计费组织 | 字符串 | 初始化 |  | 成本归属组织 |  |
| 物流运费明细表 | 物流公司 | 字符串 | 初始化 |  | 承运商名称 |  |
| 物流运费明细表 | 出库物理仓 | 字符串 | 初始化 |  | 发货物理仓名称 |  |
| 物流运费明细表 | 承运方式 | 字符串 | 初始化 |  | 承运方式 | 干线/快递/零担等 |
| 物流运费明细表 | 业务类型 | 字符串 | 初始化 |  | 业务类型 | 订单/调拨等类型 |
| 物流运费明细表 | 物理仓 | 字符串 | 初始化 |  | 物理仓 |  |
| 物流运费明细表 | 调出仓 | 字符串 | 初始化 |  | 调出仓 |  |
| 物流运费明细表 | 调出库存组织 | 字符串 | 初始化 |  | 调出库存组织 |  |
| 物流运费明细表 | 调入仓 | 字符串 | 初始化 |  | 调入仓 | 调入物理仓名称 |
| 物流运费明细表 | 调入库存组织 | 字符串 | 初始化 |  | 调入库存组织 |  |

| 拆单额外成本明细表 | 出库通知单 | 字符串 | 物流运费明细表.出库通知单 |  | 出库通知单号 | 粒度=出库通知单；按记账日期归属月份 |
| 拆单额外成本明细表 | 记账日期 | 日期 | 物流运费明细表.记账日期 |  | 记账日期 | 月度归属口径 |
| 拆单额外成本明细表 | 发货日期 | 日期 | 物流运费明细表.发货日期 |  | 实际发货日期 |  |
| 拆单额外成本明细表 | 客户名称 | 字符串 | 物流运费明细表 |  | 客户名称 | 与账单列名保持一致 |
| 拆单额外成本明细表 | 客户地址 | 字符串 | 物流运费明细表 |  | 收货地址/客户地址 | 与账单列名保持一致 |
| 拆单额外成本明细表 | 收货人 | 字符串 | 物流运费明细表 |  | 收货人 |  |
| 拆单额外成本明细表 | 收货省份 | 字符串 | 物流运费明细表.所属省份 |  | 省份 | 用于直发单价聚合维度 |
| 拆单额外成本明细表 | 所属区域 | 字符串 | 物流运费明细表.所属区域 |  | 大区 |  |
| 拆单额外成本明细表 | 区/县 | 字符串 | 物流运费明细表.区/县 |  | 区县 |  |
| 拆单额外成本明细表 | WMS出库单号 | 字符串 | 物流运费明细表.WMS出库单号 |  | WMS出库单号 |  |
| 拆单额外成本明细表 | 托运单号 | 字符串 | 物流运费明细表.托运单号 |  | 托运单号 |  |
| 拆单额外成本明细表 | 出库通知单号 | 字符串 | 物流运费明细表.出库通知单 |  | 出库通知单号 | 与“出库通知单”同值 |
| 拆单额外成本明细表 | 关联业务单号 | 字符串 | 物流运费明细表.关联业务单号 |  | 关联业务单号 | 订单/调拨单号 |
| 拆单额外成本明细表 | 瓶数 | 数值 | 物流运费明细表 |  | 数量/件数/瓶数 | 与账单列名保持一致 |
| 拆单额外成本明细表 | 箱数 | 数值 | 物流运费明细表 |  | 箱数或整箱数+拼箱数 | 与账单列名保持一致 |
| 拆单额外成本明细表 | 体积(m³) | 数值 | 物流运费明细表.体积(m³) |  | 计费体积 | 单位：立方米 |
| 拆单额外成本明细表 | 重量(KG) | 数值 | 物流运费明细表.重量(KG) |  | 计费重量 | 单位：千克 |
| 拆单额外成本明细表 | 计费组织 | 字符串 | 物流运费明细表.计费组织 |  | 成本归属组织 |  |
| 拆单额外成本明细表 | 物流公司 | 字符串 | 物流运费明细表.物流公司 |  | 承运商名称 |  |
| 拆单额外成本明细表 | 出库物理仓 | 字符串 | 物流运费明细表.出库物理仓 |  | 实际发货物理仓 | 若同通知单多仓，按体积分摊用于调拨分摊 |
| 拆单额外成本明细表 | 承运方式 | 字符串 | 物流运费明细表.承运方式 |  | 承运方式 | 快递/零担/干线等 |
| 拆单额外成本明细表 | 业务类型 | 字符串 | 物流运费明细表.业务类型 |  | 业务类型 | 订单/销售/普通调拨等 |
| 拆单额成本明细表 | 实际物流运费 | 数值 | 物流运费明细表.运费合计 |  | 运费金额 | 单位：元；同通知单聚合 |
| 拆单额外成本明细表 | 目标仓 | 字符串 | 销售订单明细.出库通知单号, 销售订单明细.预计发货物理仓, 物流运费明细表.出库通知单 | 通过出库通知单关联销售明细取“预计发货物理仓” | 预计发货物理仓 | 关联：物流运费明细表.出库通知单 ↔ 销售订单明细.出库通知单号 |
| 拆单额外成本明细表 | 模拟物流运费单价(元/m³) | 数值 | 物流运费明细表.运费合计, 物流运费明细表.体积(m³), 物流运费明细表.出库物理仓, 物流运费明细表.所属省份, 物流运费明细表.业务类型, 物流运费明细表.记账日期 | 单价=Σ运费合计/Σ体积 where 出库物理仓=目标仓 AND 所属省份=本单省份 AND 业务类型∈('订单','销售') AND 月=当月(记账日期) | 来自账单的历史均价 | 分母为0时按近3个月→全年→全网同口径回退 |
| 拆单额外成本明细表 | 模拟调拨运费单价(元/m³) | 数值 | 物流运费明细表.运费合计, 物流运费明细表.体积(m³), 物流运费明细表.调入仓, 物流运费明细表.业务类型, 物流运费明细表.记账日期 | 单价=IF(调入仓=珠海仓, 0, Σ运费合计/Σ体积) where 业务类型='普通调拨' AND 调入仓=目标仓 AND 月=当月(记账日期) | 来自账单的历史均价 | 珠海仓调入单价固定为0 |
| 拆单额外成本明细表 | 本单调拨运费 | 数值 | 模拟调拨运费单价, 物流运费明细表.体积(m³), 物流运费明细表.出库物理仓 | 金额=Σ[IF(入仓=珠海仓,0,单价(入=该出库仓,当月))×该出库仓体积] | 规则计算 | 多实际发货仓按体积分摊后求和 |
| 拆单额外成本明细表 | 目标仓直发模拟运费 | 数值 | 模拟物流运费单价, 物流运费明细表.体积(m³) | 金额=模拟物流运费单价×本单体积(m³) | 规则计算 | 直发口径业务类型固定为('订单','销售') |
| 拆单额外成本明细表 | 目标仓调拨模拟运费 | 数值 | 模拟调拨运费单价, 物流运费明细表.体积(m³) | 金额=模拟调拨运费单价×本单体积(m³) | 规则计算 | 若目标仓=珠海仓则金额=0 |
| 拆单额外成本明细表 | 拆单额外成本 | 数值 | 实际物流运费, 本单调拨运费, 目标仓直发模拟运费, 目标仓调拨模拟运费, 出库物理仓, 目标仓 | IF(出库物理仓集合=仅目标仓, 0, 实际物流运费 + 本单调拨运费 − 目标仓直发模拟运费 − 目标仓调拨模拟运费) | 规则计算 | 出库物理仓=目标仓时记0 |

---

## 7. 核心业务规则与数据处理逻辑

### 7.1 数据聚合规则
- **代发需求聚合**：销售明细表通过"预计发货物理仓"与"实际发货物理仓"比较判断代发方向；按"归属组织 × SKU × 预计发货物理仓 × 自然周"汇总代出量和代入量，计算净代发量。
- **库存聚合**：逻辑仓档案过滤"仓库品质=合格、计费组织=归属组织、仓库分类=逻辑仓"；按"归属组织 × SKU × 物理仓"聚合即时库存、可用库存。在途库存从调拨单明细表筛选"单据状态=待收货"聚合。
- **批次池构建**：筛选"仓库品质=合格、仓库分类=逻辑仓"的逻辑仓；从即时库存表获取批次号、批次库存数量等信息。计费组织=归属组织的批次默认可用；计费组织为上级组织的批次需人工确认。

### 7.2 核心业务规则
- **止拨规则**：止拨阈值 = 周转库存（周基准）+ 安全库存（周基准）；可按"物理仓×SKU"配置，可附黑白名单。可调拨量 = max(0, 即时库存 − 止拨阈值)。紧急订单可越权（需审批）。
- **补货触发**：触发条件 = 库存水位（可用库存 + 在途库存）< ROP(日)；理论缺口 = 目标库存（日）− 库存水位；建议补货量 = min(理论缺口, 止拨后可分配量)。
- **批次选择**：先进先出（FIFO）；可跨批选择；按缺口比例分配；整托优先（不拆托）。
- **分配与裁剪**：按RDC缺口比例分配；按装箱数/托盘取整；不涉及装载/线路裁剪；K值/拆分限制/比例容差等取自“调拨策略参数表”（无配置采用默认）。
- **跨月周处理**：自然周跨月时，照常生成周预测和补货计划；月度KPI/财务按自然日拆分归属。

---

## 8. 场景样例（推荐）
### 8.1 批次跨月且按比例分配的计划数量示例（未做装载裁剪）
> 说明：本例为“计划数量”口径，已在分配时按箱（10 件/箱）和整托规则取整；同一批次视为一托板，遵循“整托不拆”原则。未进行装载/托盘/线路等最终裁剪，因此不代表最终调拨数量。

0）输入
- 调入仓缺口（占比）：W1=600，W2=300，W3=100；合计 1,000 → 比例 = 0.6 / 0.3 / 0.1
- 批次池（跨月）：1 月 B1=300；2 月 B2=500；3 月 B3=400，批次合计=1,200
- 止拨后可分配量：900 → 缩放系数 = 900 / 1,200 = 0.75
- 有效“可分配月量”：1 月 225，2 月 375，3 月 300

1）目标（未取整，月内均按 0.6/0.3/0.1 比例分摊）
- 1 月（225）：W1=135，W2=67.5，W3=22.5
- 2 月（375）：W1=225，W2=112.5，W3=37.5
- 3 月（300）：W1=180，W2=90，W3=30
- 合计：W1=540，W2=270，W3=90（合计 900）

2）执行规则（保守拆分）
- K=2：同一批次最多去 2 个仓
- 仅允许月内最后一批被拆分（其余批次整批发）
- 最小拆分量≥3 箱（10 件/箱 → 30 件）
- 整托/整箱优先：按包装倍数（10 件/箱）取整
- 比例容差 ε=±2%（月内分配完成后校验，超出进入“未分配清单”）

3）逐月落地（示例用“当月批次”说明，仅为演示）
- 1 月（225），当月批次：J1=120、J2=70、J3=35
  - 目标：W1 135、W2 67.5、W3 22.5
  - 分配：J1→W1=120（整批）；J2→W2=60（整箱，余10）；J3→W3=20（整箱，余15）
  - 只拆最后一批？W1 尚差15，J3 余15 < 30（最小拆分量）→ 不拆
  - 结果：W1=120，W2=60，W3=20；未分配=25（入“未分配清单”，下月优先补齐）
- 2 月（375），当月批次：F1=200、F2=175
  - 目标：W1 225、W2 112.5、W3 37.5
  - 分配：F1→W1=200（整批）；F2 拆分→W2=120、W3=50（两去向，均≥30，余5）
  - 结果：W1=200，W2=120，W3=50；未分配=5
- 3 月（300），当月批次：M1=180、M2=120
  - 目标：W1 180、W2 90、W3 30
  - 分配：M1→W1=180（整批）；M2 拆分→W2=90、W3=30（两去向，均≥30）
  - 结果：W1=180，W2=90，W3=30；未分配=0

4）汇总校验
- 已分配合计：
  - 1 月 200 + 2 月 370 + 3 月 300 = 870
  - ≤ 900（止拨上限），但未吃满（原因：最小拆分量与仅拆最后一批的约束）
- 到仓合计：
  - W1=120+200+180=500
  - W2=60+120+90=270
  - W3=20+50+30=100
  - 合计 870（与已分配一致）

说明：此“保守方案”优先控制分拣次数与操作复杂度 → 会牺牲一部分可分配量（900 → 870）。

---
