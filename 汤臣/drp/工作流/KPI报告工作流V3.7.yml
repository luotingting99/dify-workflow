app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: KPIæŠ¥å‘Šå·¥ä½œæµV3.7-uat
  use_icon_as_answer_icon: false
dependencies: []
kind: app
version: 0.4.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: agent
      id: 1761813418553-source-1761813421469-target
      source: '1761813418553'
      sourceHandle: source
      target: '1761813421469'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: agent
        targetType: code
      id: 1761813421469-source-1761813430000-target
      source: '1761813421469'
      sourceHandle: source
      target: '1761813430000'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: end
      id: 1761813430000-source-1761813424398-target
      source: '1761813430000'
      sourceHandle: source
      target: '1761813424398'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - default: ''
          hint: ''
          label: query
          max_length: 48
          options: []
          placeholder: ''
          required: true
          type: text-input
          variable: query
        - default: ''
          hint: ''
          label: time_window
          max_length: 48
          options: []
          placeholder: ''
          required: true
          type: text-input
          variable: time_window
        - default: ''
          hint: ''
          label: intent
          max_length: 48
          options: []
          placeholder: ''
          required: true
          type: text-input
          variable: intent
        - default: ''
          hint: ''
          label: warehouse
          max_length: 48
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: warehouse
      height: 166
      id: '1761813418553'
      position:
        x: 80
        y: 282
      positionAbsolute:
        x: 80
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        agent_parameters:
          instruction:
            type: constant
            value: "â—â—â—æ‰§è¡Œè§„åˆ™â—â—â—\n1. è°ƒç”¨duckdb_queryå·¥å…·æ‰§è¡ŒSQL\n2. å·¥å…·è¿”å›ç»“æœåï¼Œç«‹å³ç»“æŸï¼ˆä¸è¦æœ‰ä»»ä½•é¢å¤–è¾“å‡ºï¼‰\n\
              3. ç¦æ­¢è¿”å›Final Answer\n4. ç¦æ­¢ç”Ÿæˆæ€»ç»“æˆ–è¯´æ˜æ–‡å­—\n5. ä½ çš„å”¯ä¸€ä»»åŠ¡å°±æ˜¯ï¼šæ‰§è¡ŒSQL â†’ ç»“æŸ\n\n# Role\n\
              KPIæŠ¥å‘ŠSQLæŸ¥è¯¢å™¨ï¼Œä½¿ç”¨duckdb_queryå·¥å…·æ‰§è¡ŒSQLå¹¶è¿”å›åŸå§‹æ•°æ®ã€‚\n\n# Task\nè¾“å…¥: query, time_window,\
              \ intent, warehouse(å¯é€‰)\nè¾“å‡º: åŸå§‹SQLæŸ¥è¯¢ç»“æœï¼ˆç”±åç»­CodeèŠ‚ç‚¹æ ¼å¼åŒ–ï¼‰\nè¦æ±‚: å‡†ç¡®ã€é«˜æ•ˆ(1æ¬¡æŸ¥è¯¢)ã€ä»…è¿”å›åŸå§‹æ•°æ®\n\
              \nâ—â—â—å…³é”®çº¦æŸï¼š\n- æ‰§è¡ŒSQLåç«‹å³åœæ­¢ï¼Œä¸è¦ç»§ç»­æ€è€ƒ\n- ä¸è¦ç”ŸæˆFinal Answerï¼ˆæµªè´¹tokenï¼‰\n- ä¸è¦è¾“å‡ºä»»ä½•æ€»ç»“æˆ–è¯´æ˜ï¼ˆåç»­èŠ‚ç‚¹ä¼šå¤„ç†ï¼‰\n\
              - åŸå§‹æ•°æ®ä¼šè‡ªåŠ¨ä¼ é€’ç»™CodeèŠ‚ç‚¹\n\n---\n\n# Instructions\n\n## æ ¸å¿ƒåŸåˆ™\n1. å®‰å…¨åªè¯»: ä»…SELECTï¼Œç¦æ­¢DDL/DML\n\
              2. ä¸€æ¬¡è·å–: CTE+JOINä¸€æ¬¡æŸ¥è¯¢æœ¬æœŸ/ä¸ŠæœŸ/åŒæœŸ\n3. NULLå®‰å…¨: COALESCE+NULLIFå¤„ç†ç©ºå€¼é™¤é›¶\n4.\
              \ DuckDBæ–¹è¨€: DATEå­—é¢é‡ï¼Œ||è¿æ¥ï¼ŒCASTè½¬æ¢\n5. ç¦æ­¢LIMIT: ä¸ä½¿ç”¨LIMITè¯­å¥\n6. åŸå§‹æ•°æ®: è¿”å›æ•°æ®åº“åŸå§‹å€¼ï¼Œä¸åšæ ¼å¼åŒ–\n\
              \n## å¤„ç†æµç¨‹ï¼ˆä»…1ä¸ªæ­¥éª¤ï¼‰\n\n**æ­¥éª¤1ï¼ˆå”¯ä¸€æ­¥éª¤ï¼‰**: ä½¿ç”¨duckdb_queryå·¥å…·æ‰§è¡Œä¸€æ¬¡æ€§SQLæŸ¥è¯¢ï¼Œè·å–æ‰€æœ‰æ•°æ®\n\
              - è§£ætime_window: base_date, prev_date, yoy_date\n- æ£€æŸ¥warehouseæ˜¯å¦ä¸ºå ä½ç¬¦\n\
              - ä½¿ç”¨UNION ALLåˆå¹¶3ç±»æ•°æ®ï¼š\n  1. å±¥çº¦æŒ‡æ ‡ï¼ˆdata_type='fulfillment'ï¼‰\n  2. æˆæœ¬ä¸šåŠ¡ç±»å‹ï¼ˆdata_type='cost_business'ï¼‰\n\
              \  3. çœä»½æˆæœ¬ï¼ˆdata_type='cost_province'ï¼‰\n- ä¸€æ¬¡SQLæŸ¥è¯¢è¿”å›æ‰€æœ‰éœ€è¦çš„æ•°æ®\n- ä½¿ç”¨ä¸‹æ–¹çš„\"\
              ä¸€æ¬¡æ€§SQLæ¨¡æ¿\"\n- æ‰§è¡Œå®ŒSQLæŸ¥è¯¢åç«‹å³è‡ªåŠ¨ç»“æŸ\n\nâ—â—â—å¼ºåˆ¶çº¦æŸï¼š\n1. åªæ‰§è¡Œ1æ¬¡duckdb_queryå·¥å…·è°ƒç”¨\n\
              2. æŸ¥è¯¢å®Œæˆåç«‹å³è‡ªåŠ¨ç»“æŸï¼Œä¸è¾“å‡ºFinal Answer\n3. ä¸è¿›è¡Œä»»ä½•æ•°æ®æ ¼å¼åŒ–ï¼ˆç”±åç»­CodeèŠ‚ç‚¹å®Œæˆï¼‰\n\n## ä»“åº“è¿‡æ»¤è§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰\n\
              warehouseä¸ºä»¥ä¸‹ä»»ä¸€æƒ…å†µæ—¶è§†ä¸º\"æœªæŒ‡å®š\"ï¼ŒSQLä¸­ä¸æ·»åŠ ä»“åº“è¿‡æ»¤ï¼š\n- ç©ºå€¼ã€NULLã€ç©ºå­—ç¬¦ä¸²\n- \"N/A\"ã€\"\
              null\"ã€\"undefined\"ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰\n- ä»¥\"qc.\"å¼€å¤´ï¼ˆå¦‚qc.structured_output.warehouseï¼‰\n\
              - ä»¥\"qs.\"å¼€å¤´\n- åŒ…å«\"structured_output\"\n\nâ—åªæœ‰warehouseæ˜¯çœŸå®ä»“åº“åæ—¶ï¼Œæ‰åœ¨SQL\
              \ WHEREä¸­æ·»åŠ ä»“åº“è¿‡æ»¤æ¡ä»¶\n\n## å…³é”®çº¦æŸ\n1. ä¼˜å…ˆmonth_start_date=DATEï¼Œé¿å…ym='å­—ç¬¦ä¸²'\n\
              2. SQLå¿…é¡»åŒ…å«periodå’Œdata_typeå­—æ®µ\n3. å¦‚æŸ¥è¯¢ç»“æœæ— yoyæ•°æ®ï¼Œè¿”å›ç©ºè¡Œå³å¯\n4. ç¦æ­¢ä½¿ç”¨LIMITè¯­å¥\n\
              5. åªæ‰§è¡Œ1æ¬¡å·¥å…·è°ƒç”¨\n6. æŸ¥è¯¢å®Œæˆåç«‹å³ç»“æŸï¼Œä¸è¾“å‡ºFinal Answer\n\n---\n\n# Tables & Schemas\n\
              \n## å±¥çº¦æŒ‡æ ‡è¡¨\nå¯ç”¨è¡¨: \n- æœˆåº¦: mart_kpi_fill_rate_monthly_wh, mart_kpi_old_batch_monthly_wh\n\
              - å‘¨åº¦: mart_kpi_fill_rate_weekly_wh_province, mart_kpi_old_batch_weekly_wh_province\n\
              \nå­—æ®µ(æœˆåº¦fill_rate): month_start_date(DATE,ä¸»é”®), ym(INT,202504), physical_warehouse(VARCHAR),\
              \ warehouse_code(VARCHAR), scenario_id(VARCHAR), total_orders_expected(INT),\
              \ local_orders_fulfilled(INT), total_orders_cross_split(INT), local_fill_rate(DECIMAL)\n\
              \nå­—æ®µ(æœˆåº¦old_batch): month_start_date(DATE,ä¸»é”®), physical_warehouse(VARCHAR),\
              \ warehouse_code(VARCHAR), scenario_id(VARCHAR), orders_with_shipment(INT),\
              \ old_batch_cross_split_orders(INT), old_batch_rate_of_shipped(DECIMAL)\n\
              \nå­—æ®µ(å‘¨åº¦): forecast_week_start_date(DATE,ä¸»é”®), forecast_week_end_date,\
              \ forecast_week, physical_warehouse, warehouse_code, province, scenario_id,\
              \ total_orders_expected, local_orders_fulfilled, orders_with_shipment...\n\
              \nè”è¡¨é”®: month_start_date + warehouse_code + scenario_id (å‘¨åº¦ç”¨forecast_week_start_date)\n\
              \n## æˆæœ¬è¡¨\n### ç‰©æµè¿è´¹ç‰©ç†æ˜ç»†è¡¨\nè¡¨å: mart_logistics_freight_detailï¼ˆç‰©æµè¿è´¹ç‰©ç†æ˜ç»†ï¼‰\n\næ ¸å¿ƒå­—æ®µ: \n- æ—¶é—´:\
              \ posting_date(DATEè®°è´¦æ—¥æœŸ), billing_date(DATEè®¡è´¹æ—¥æœŸ), shipment_date(DATEå‘è´§æ—¥æœŸ)\n\
              - ä¸šåŠ¡: business_type(TEXTä¸šåŠ¡ç±»å‹:è®¢å•/è°ƒæ‹¨), related_business_no(TEXTå…³è”ä¸šåŠ¡å•å·),\
              \ wms_outbound_no(TEXTå‡ºåº“å•å·)\n- ä»“åº“: physical_warehouse(TEXTç‰©ç†ä»“), physical_warehouse_out(TEXTå‡ºåº“ç‰©ç†ä»“),\
              \ warehouse_out(TEXTè°ƒå‡ºä»“), warehouse_in(TEXTè°ƒå…¥ä»“)\n- åœ°åŒº: province(TEXTçœä»½),\
              \ region(TEXTåŒºåŸŸ), district(TEXTåŒº/å¿)\n- æ•°é‡: bottle_qty(BIGINTç“¶æ•°), case_qty(BIGINTç®±æ•°),\
              \ volume_m3(DOUBLEä½“ç§¯mÂ³), weight_kg(DOUBLEé‡é‡KG)\n- æˆæœ¬: freight_total_amount(DOUBLEè¿è´¹åˆè®¡),\
              \ freight_amount(DOUBLEåŸºç¡€è¿è´¹), delivery_fee(DOUBLEé…é€è´¹), unloading_fee(DOUBLEå¸è´§è´¹),\
              \ special_fee(DOUBLEç‰¹æ®Šè´¹ç”¨)\n- å…¶ä»–: logistics_company(TEXTç‰©æµå…¬å¸), carrier_mode(TEXTæ‰¿è¿æ–¹å¼),\
              \ charge_type(TEXTè®¡è´¹æ–¹å¼)\n\næ—¶é—´å­—æ®µé€‰æ‹©: \n- æœˆåº¦æŠ¥å‘Š: æŒ‰billing_dateæˆ–posting_dateåˆ†ç»„ï¼ˆä¼˜å…ˆbilling_dateï¼‰\n\
              - å‘¨åº¦æŠ¥å‘Š: æŒ‰shipment_dateåˆ†ç»„\n\n### æ‹†å•é¢å¤–æˆæœ¬æ˜ç»†è¡¨\nè¡¨å: mart_split_order_extra_cost_detailï¼ˆæ‹†å•é¢å¤–æˆæœ¬é€å•æ˜ç»†ï¼‰\n\
              \næ ¸å¿ƒå­—æ®µ:\n- æ—¶é—´: posting_month(DATEæœˆä»½,ä¸»é”®ä¹‹ä¸€)\n- åœ°åŒº: province(TEXTçœä»½),\
              \ province_code(TEXTçœä»½ç¼–ç )\n- ä»“åº“: target_warehouse(TEXTç›®æ ‡ä»“,ä¸»é”®ä¹‹ä¸€), physical_warehouse_out(TEXTå®é™…å‡ºåº“ä»“)\n\
              - ä¸šåŠ¡: business_type(TEXTä¸šåŠ¡ç±»å‹), related_business_no(TEXTå…³è”ä¸šåŠ¡å•å·,ä¸»é”®ä¹‹ä¸€),\
              \ wms_outbound_no(TEXTå‡ºåº“å•å·)\n- æ•°é‡: volume_m3(DOUBLEä½“ç§¯mÂ³), weight_kg(DOUBLEé‡é‡KG),\
              \ bottle_qty(BIGINTç“¶æ•°)\n- æˆæœ¬æ˜ç»†:\n  - actual_freight_amount(DOUBLEå®é™…è¿è´¹):\
              \ å®é™…å‘ç”Ÿçš„è¿è´¹\n  - current_transfer_freight(DOUBLEå½“å‰è°ƒæ‹¨è¿è´¹): ä»è°ƒå‡ºä»“è°ƒå…¥åˆ°ç›®æ ‡ä»“çš„è¿è´¹\n\
              \  - target_direct_simulated_freight(DOUBLEç›®æ ‡ä»“ç›´å‘æ¨¡æ‹Ÿè¿è´¹): å¦‚æœä»ç›®æ ‡ä»“ç›´æ¥å‘è´§çš„æ¨¡æ‹Ÿè¿è´¹\n\
              \  - target_transfer_simulated_freight(DOUBLEç›®æ ‡ä»“è°ƒæ‹¨æ¨¡æ‹Ÿè¿è´¹): å¦‚æœå…ˆè°ƒå…¥ç›®æ ‡ä»“å†å‘è´§çš„æ¨¡æ‹Ÿè¿è´¹\n\
              \  - split_order_extra_cost(DOUBLEæ‹†å•é¢å¤–æˆæœ¬): **æ ¸å¿ƒæŒ‡æ ‡**ï¼Œé€å•æ ¸ç®—çš„é¢å¤–æˆæœ¬ï¼ˆå·²å«å®Œæ•´è®¡ç®—é€»è¾‘ï¼‰\n\
              - å…¶ä»–: logistics_company(TEXTç‰©æµå…¬å¸), carrier_mode(TEXTæ‰¿è¿æ–¹å¼)\n\n**é‡è¦å£å¾„è¯´æ˜**:\n\
              - `split_order_extra_cost` æ˜¯å·²å®Œæˆé€å•æ ¸ç®—çš„æœ€ç»ˆå€¼\n- æŒ‰æœˆæ±‡æ€»æ—¶ç›´æ¥ SUM(split_order_extra_cost)\
              \ å³å¯\n- æ—¶é—´è¿‡æ»¤: æŒ‰ posting_month å­—æ®µï¼ˆDATEç±»å‹ï¼‰\n- èšåˆç»´åº¦: å¯æŒ‰ provinceã€target_warehouseã€business_type\
              \ ç­‰ç»´åº¦èšåˆ\n\n---\n\n# SQL Guidelines\n\n## DuckDBè§„èŒƒ\n\
              - æ—¥æœŸ: DATE '2025-04-01', TIMESTAMP '2025-04-01 10:00:00'\n- å­—ç¬¦ä¸²: ä½¿ç”¨\
              \ ||\n- ç±»å‹: CAST(x AS type)\n- é¿å…: NVL/DECODE/TO_CHAR\n- ç¦æ­¢: LIMITè¯­å¥ï¼ˆå°¤å…¶é…åˆORDER\
              \ BYèšåˆå‡½æ•°ï¼‰\n\n## ä¸€æ¬¡æ€§SQLæ¨¡æ¿ï¼ˆå…¨éƒ¨æ•°æ®ï¼Œæœˆåº¦-å…¨ä»“ï¼‰\n\nâ—â—â—ä½¿ç”¨æ­¤æ¨¡æ¿ï¼Œä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®ï¼š\n\n```sql\n\
              WITH \ntime_params AS (\n  SELECT \n    DATE '2025-04-01' AS base_date,\n\
              \    DATE '2025-04-01' - INTERVAL 1 MONTH AS prev_date,\n    DATE '2025-04-01'\
              \ - INTERVAL 1 YEAR AS yoy_date,\n    DATE '2025-04-01' AS base_month,\n\
              \    DATE '2025-04-01' - INTERVAL 1 MONTH AS prev_month,\n    DATE '2025-04-01'\
              \ - INTERVAL 1 YEAR AS yoy_month\n),\n\n-- Part 1: å±¥çº¦æŒ‡æ ‡\nfulfillment_data\
              \ AS (\n  SELECT \n    CASE \n      WHEN fr.month_start_date = tp.base_date\
              \ THEN 'current'\n      WHEN fr.month_start_date = tp.prev_date THEN\
              \ 'previous'\n      WHEN fr.month_start_date = tp.yoy_date THEN 'yoy'\n\
              \    END AS period,\n    fr.physical_warehouse,\n    SUM(fr.total_orders_expected)\
              \ AS total_expected,\n    SUM(fr.local_orders_fulfilled) AS local_fulfilled,\n\
              \    SUM(fr.total_orders_cross_split) AS cross_split,\n    SUM(COALESCE(ob.orders_with_shipment,\
              \ 0)) AS orders,\n    SUM(COALESCE(ob.old_batch_cross_split_orders,\
              \ 0)) AS old_batch_split,\n    ROUND(SUM(fr.local_orders_fulfilled)*1.0/NULLIF(SUM(fr.total_orders_expected),0),\
              \ 4) AS local_rate,\n    ROUND(SUM(fr.total_orders_cross_split)*1.0/NULLIF(SUM(fr.total_orders_expected),0),\
              \ 4) AS split_rate,\n    ROUND(SUM(COALESCE(ob.old_batch_cross_split_orders,0))*1.0/NULLIF(SUM(fr.total_orders_cross_split),0),\
              \ 4) AS old_ratio\n  FROM mart_kpi_fill_rate_monthly_wh fr\n  CROSS\
              \ JOIN time_params tp\n  LEFT JOIN mart_kpi_old_batch_monthly_wh ob\
              \ \n    ON fr.month_start_date = ob.month_start_date\n    AND fr.warehouse_code\
              \ = ob.warehouse_code\n    AND fr.scenario_id = ob.scenario_id\n  WHERE\
              \ fr.month_start_date IN (tp.base_date, tp.prev_date, tp.yoy_date)\n\
              \    -- å¦‚æœwarehouseä¸ºçœŸå®ä»“åº“åï¼Œæ·»åŠ ï¼šAND (fr.physical_warehouse = 'åä¸œä»“' OR fr.warehouse_code\
              \ = 'åä¸œä»“')\n  GROUP BY fr.month_start_date, fr.physical_warehouse, tp.base_date,\
              \ tp.prev_date, tp.yoy_date\n),\nfulfillment_final AS (\n  SELECT \n\
              \    'fulfillment' AS data_type,\n    period,\n    physical_warehouse,\n\
              \    CAST(NULL AS VARCHAR) AS province,\n    CAST(NULL AS VARCHAR) AS\
              \ biz_type,\n    total_expected,\n    local_fulfilled,\n    cross_split,\n\
              \    orders,\n    old_batch_split,\n    local_rate,\n    split_rate,\n\
              \    old_ratio,\n    CAST(NULL AS DOUBLE) AS total_freight,\n    CAST(NULL\
              \ AS DOUBLE) AS total_volume,\n    CAST(NULL AS DOUBLE) AS unit_cost\n\
              \  FROM fulfillment_data\n),\n\n-- Part 2: æˆæœ¬ä¸šåŠ¡ç±»å‹\ncost_business AS\
              \ (\n  SELECT \n    'cost_business' AS data_type,\n    CASE \n     \
              \ WHEN DATE_TRUNC('month', billing_date) = tp.base_month THEN 'current'\n\
              \      WHEN DATE_TRUNC('month', billing_date) = tp.prev_month THEN 'previous'\n\
              \      WHEN DATE_TRUNC('month', billing_date) = tp.yoy_month THEN 'yoy'\n\
              \    END AS period,\n    CAST(NULL AS VARCHAR) AS physical_warehouse,\n\
              \    CAST(NULL AS VARCHAR) AS province,\n    CASE \n      WHEN business_type\
              \ LIKE '%è®¢å•%' THEN 'è®¢å•'\n      WHEN business_type LIKE '%è°ƒæ‹¨%' THEN 'è°ƒæ‹¨'\n\
              \      ELSE 'å…¶ä»–'\n    END AS biz_type,\n    CAST(NULL AS BIGINT) AS\
              \ total_expected,\n    CAST(NULL AS BIGINT) AS local_fulfilled,\n  \
              \  CAST(NULL AS BIGINT) AS cross_split,\n    CAST(NULL AS BIGINT) AS\
              \ orders,\n    CAST(NULL AS BIGINT) AS old_batch_split,\n    CAST(NULL\
              \ AS DOUBLE) AS local_rate,\n    CAST(NULL AS DOUBLE) AS split_rate,\n\
              \    CAST(NULL AS DOUBLE) AS old_ratio,\n    SUM(COALESCE(freight_total_amount,\
              \ 0)) AS total_freight,\n    SUM(COALESCE(volume_m3, 0)) AS total_volume,\n\
              \    ROUND(SUM(COALESCE(freight_total_amount, 0))*1.0/NULLIF(SUM(COALESCE(volume_m3,\
              \ 0)), 0), 2) AS unit_cost\n  FROM mart_logistics_freight_detail, time_params\
              \ tp\n  WHERE DATE_TRUNC('month', billing_date) IN (tp.base_month, tp.prev_month,\
              \ tp.yoy_month)\n  GROUP BY DATE_TRUNC('month', billing_date), biz_type,\
              \ tp.base_month, tp.prev_month, tp.yoy_month\n),\n\n-- Part 3: çœä»½æˆæœ¬\n\
              cost_province AS (\n  SELECT \n    'cost_province' AS data_type,\n \
              \   CASE \n      WHEN DATE_TRUNC('month', billing_date) = tp.base_month\
              \ THEN 'current'\n      WHEN DATE_TRUNC('month', billing_date) = tp.prev_month\
              \ THEN 'previous'\n      WHEN DATE_TRUNC('month', billing_date) = tp.yoy_month\
              \ THEN 'yoy'\n    END AS period,\n    CAST(NULL AS VARCHAR) AS physical_warehouse,\n\
              \    province,\n    CAST(NULL AS VARCHAR) AS biz_type,\n    CAST(NULL\
              \ AS BIGINT) AS total_expected,\n    CAST(NULL AS BIGINT) AS local_fulfilled,\n\
              \    CAST(NULL AS BIGINT) AS cross_split,\n    CAST(NULL AS BIGINT)\
              \ AS orders,\n    CAST(NULL AS BIGINT) AS old_batch_split,\n    CAST(NULL\
              \ AS DOUBLE) AS local_rate,\n    CAST(NULL AS DOUBLE) AS split_rate,\n\
              \    CAST(NULL AS DOUBLE) AS old_ratio,\n    SUM(COALESCE(freight_total_amount,\
              \ 0)) AS total_freight,\n    SUM(COALESCE(volume_m3, 0)) AS total_volume,\n\
              \    ROUND(SUM(COALESCE(freight_total_amount, 0))*1.0/NULLIF(SUM(COALESCE(volume_m3,\
              \ 0)), 0), 2) AS unit_cost\n  FROM mart_logistics_freight_detail, time_params\
              \ tp\n  WHERE DATE_TRUNC('month', billing_date) IN (tp.base_month, tp.prev_month,\
              \ tp.yoy_month)\n    AND province IS NOT NULL\n  GROUP BY DATE_TRUNC('month',\
              \ billing_date), province, tp.base_month, tp.prev_month, tp.yoy_month\n\
              )\n\n-- âš ï¸ Part 4-6: æ‹†å•é¢å¤–æˆæœ¬ï¼ˆæš‚æ—¶æ³¨é‡Šï¼Œç­‰è¡¨åˆ›å»ºåå¯ç”¨ï¼‰\n-- ç›®å‰ä½¿ç”¨ä¼°ç®—å£å¾„ä½œä¸ºå…œåº•\n/*\n\
              -- Part 4: æ‹†å•é¢å¤–æˆæœ¬ï¼ˆæ€»è§ˆï¼‰\nsplit_extra_overall AS (\n  SELECT \n    'split_extra_overall'\
              \ AS data_type,\n    CASE \n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.base_month THEN 'current'\n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.prev_month THEN 'previous'\n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.yoy_month THEN 'yoy'\n    END AS period,\n    CAST(NULL AS VARCHAR)\
              \ AS physical_warehouse,\n    CAST(NULL AS VARCHAR) AS province,\n    CAST(NULL\
              \ AS VARCHAR) AS biz_type,\n    CAST(NULL AS BIGINT) AS total_expected,\n\
              \    CAST(NULL AS BIGINT) AS local_fulfilled,\n    CAST(NULL AS BIGINT)\
              \ AS cross_split,\n    CAST(NULL AS BIGINT) AS orders,\n    CAST(NULL AS\
              \ BIGINT) AS old_batch_split,\n    CAST(NULL AS DOUBLE) AS local_rate,\n\
              \    CAST(NULL AS DOUBLE) AS split_rate,\n    CAST(NULL AS DOUBLE) AS old_ratio,\n\
              \    SUM(COALESCE(split_order_extra_cost, 0)) AS total_freight,\n    CAST(NULL\
              \ AS DOUBLE) AS total_volume,\n    CAST(NULL AS DOUBLE) AS unit_cost\n \
              \ FROM mart_split_order_extra_cost_detail, time_params tp\n  WHERE DATE_TRUNC('month',\
              \ posting_month) IN (tp.base_month, tp.prev_month, tp.yoy_month)\n  GROUP\
              \ BY DATE_TRUNC('month', posting_month), tp.base_month, tp.prev_month, tp.yoy_month\n\
              ),\n\n-- Part 5: æ‹†å•é¢å¤–æˆæœ¬ï¼ˆæŒ‰ä»“ï¼‰\nsplit_extra_wh AS (\n  SELECT \n    'split_extra_wh'\
              \ AS data_type,\n    CASE \n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.base_month THEN 'current'\n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.prev_month THEN 'previous'\n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.yoy_month THEN 'yoy'\n    END AS period,\n    target_warehouse AS\
              \ physical_warehouse,\n    CAST(NULL AS VARCHAR) AS province,\n    CAST(NULL\
              \ AS VARCHAR) AS biz_type,\n    CAST(NULL AS BIGINT) AS total_expected,\n\
              \    CAST(NULL AS BIGINT) AS local_fulfilled,\n    CAST(NULL AS BIGINT)\
              \ AS cross_split,\n    CAST(NULL AS BIGINT) AS orders,\n    CAST(NULL AS\
              \ BIGINT) AS old_batch_split,\n    CAST(NULL AS DOUBLE) AS local_rate,\n\
              \    CAST(NULL AS DOUBLE) AS split_rate,\n    CAST(NULL AS DOUBLE) AS old_ratio,\n\
              \    SUM(COALESCE(split_order_extra_cost, 0)) AS total_freight,\n    CAST(NULL\
              \ AS DOUBLE) AS total_volume,\n    CAST(NULL AS DOUBLE) AS unit_cost\n \
              \ FROM mart_split_order_extra_cost_detail, time_params tp\n  WHERE DATE_TRUNC('month',\
              \ posting_month) IN (tp.base_month, tp.prev_month, tp.yoy_month)\n    AND\
              \ target_warehouse IS NOT NULL\n  GROUP BY DATE_TRUNC('month', posting_month),\
              \ target_warehouse, tp.base_month, tp.prev_month, tp.yoy_month\n),\n\n--\
              \ Part 6: æ‹†å•é¢å¤–æˆæœ¬ï¼ˆæŒ‰çœï¼‰\nsplit_extra_province AS (\n  SELECT \n    'split_extra_province'\
              \ AS data_type,\n    CASE \n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.base_month THEN 'current'\n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.prev_month THEN 'previous'\n      WHEN DATE_TRUNC('month', posting_month)\
              \ = tp.yoy_month THEN 'yoy'\n    END AS period,\n    CAST(NULL AS VARCHAR)\
              \ AS physical_warehouse,\n    province,\n    CAST(NULL AS VARCHAR) AS biz_type,\n\
              \    CAST(NULL AS BIGINT) AS total_expected,\n    CAST(NULL AS BIGINT) AS\
              \ local_fulfilled,\n    CAST(NULL AS BIGINT) AS cross_split,\n    CAST(NULL\
              \ AS BIGINT) AS orders,\n    CAST(NULL AS BIGINT) AS old_batch_split,\n \
              \   CAST(NULL AS DOUBLE) AS local_rate,\n    CAST(NULL AS DOUBLE) AS split_rate,\n\
              \    CAST(NULL AS DOUBLE) AS old_ratio,\n    SUM(COALESCE(split_order_extra_cost,\
              \ 0)) AS total_freight,\n    CAST(NULL AS DOUBLE) AS total_volume,\n   \
              \ CAST(NULL AS DOUBLE) AS unit_cost\n  FROM mart_split_order_extra_cost_detail,\
              \ time_params tp\n  WHERE DATE_TRUNC('month', posting_month) IN (tp.base_month,\
              \ tp.prev_month, tp.yoy_month)\n    AND province IS NOT NULL\n  GROUP BY\
              \ DATE_TRUNC('month', posting_month), province, tp.base_month, tp.prev_month,\
              \ tp.yoy_month\n)\n*/\n\n-- åˆå¹¶æ‰€æœ‰æ•°æ®\nSELECT * FROM fulfillment_final\n\
              UNION ALL\nSELECT * FROM cost_business\nUNION ALL\nSELECT * FROM cost_province\n\
              -- ç­‰è¡¨åˆ›å»ºåï¼Œå–æ¶ˆä¸‹é¢3è¡Œçš„æ³¨é‡Š\n-- UNION ALL\n-- SELECT * FROM split_extra_overall\n\
              -- UNION ALL\n-- SELECT * FROM split_extra_wh\n-- UNION ALL\n-- SELECT *\
              \ FROM split_extra_province\nORDER BY data_type, period;\n```\n\n**ä»“åº“è¿‡æ»¤è¯´æ˜**ï¼š\n- å¦‚æœ`warehouse`æ˜¯çœŸå®ä»“åº“åï¼ˆéå ä½ç¬¦ï¼‰ï¼Œåœ¨fulfillment_dataçš„WHEREå­å¥ä¸­æ·»åŠ ï¼š\n\
              \  `AND (fr.physical_warehouse = 'åä¸œä»“' OR fr.warehouse_code = 'åä¸œä»“')`\n\
              - æˆæœ¬æ•°æ®ä¸æŒ‰ä»“åº“è¿‡æ»¤ï¼ˆä¸šåŠ¡éœ€æ±‚ï¼‰\n\n              **æ•°æ®ç»“æ„è¯´æ˜**ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ï¼š\n- `data_type='fulfillment'`: å±¥çº¦æŒ‡æ ‡è¡Œï¼Œ`physical_warehouse`æœ‰å€¼ï¼Œ`province/biz_type/total_freight/total_volume/unit_cost`ä¸ºNULL\n\
              - `data_type='cost_business'`: æˆæœ¬ä¸šåŠ¡ç±»å‹è¡Œï¼Œ`biz_type`æœ‰å€¼ï¼Œ`physical_warehouse/province/total_expected/.../old_ratio`ä¸ºNULL\n\
              - `data_type='cost_province'`: çœä»½æˆæœ¬è¡Œï¼Œ`province`æœ‰å€¼ï¼Œ`physical_warehouse/biz_type/total_expected/.../old_ratio`ä¸ºNULL\n\
              \n**æ•°æ®ç»“æ„è¯´æ˜**ï¼ˆç­‰è¡¨åˆ›å»ºåï¼‰ï¼š\n- `data_type='split_extra_overall'`: æ‹†å•é¢å¤–æˆæœ¬æ€»è§ˆï¼Œ`total_freight`å­˜æ”¾æ€»æ‹†å•é¢å¤–æˆæœ¬ï¼Œå…¶ä»–ç»´åº¦å­—æ®µä¸ºNULL\n\
              - `data_type='split_extra_wh'`: æ‹†å•é¢å¤–æˆæœ¬æŒ‰ä»“ï¼Œ`physical_warehouse`å’Œ`total_freight`æœ‰å€¼ï¼Œå…¶ä»–ç»´åº¦å­—æ®µä¸ºNULL\n\
              - `data_type='split_extra_province'`: æ‹†å•é¢å¤–æˆæœ¬æŒ‰çœï¼Œ`province`å’Œ`total_freight`æœ‰å€¼ï¼Œå…¶ä»–ç»´åº¦å­—æ®µä¸ºNULL\n\
              \n**è¿”å›ç¤ºä¾‹**ï¼š\n- å½“å‰ç‰ˆæœ¬ï¼šæŸ¥è¯¢è¿”å›çº¦80-100è¡ŒåŸå§‹æ•°æ®ï¼ˆ3ç±»æ•°æ®ï¼‰\n- è¡¨åˆ›å»ºåï¼šæŸ¥è¯¢è¿”å›çº¦100-150è¡ŒåŸå§‹æ•°æ®ï¼ˆ6ç±»æ•°æ®ï¼‰\n\
              - æ‰€æœ‰æ•°æ®åŒ…å« current/previous/yoy ä¸‰æœŸ\n---\n\
              \n# Metrics\n\n## å±¥çº¦æŒ‡æ ‡\n| æŒ‡æ ‡ | å…¬å¼ | æ¥æº |\n|------|------|------|\n|\
              \ local_fulfillment_rate | SUM(local_fulfilled)/NULLIF(SUM(total_expected),0)\
              \ | fill_rate |\n| split_rate | SUM(cross_split)/NULLIF(SUM(total_expected),0)\
              \ | fill_rate |\n| old_batch_split_ratio | SUM(old_batch_split)/NULLIF(SUM(cross_split),0)\
              \ | old_batch |\n| orders | SUM(orders_with_shipment) | old_batch |\n\
              \n## æˆæœ¬æŒ‡æ ‡\n| æŒ‡æ ‡ | å…¬å¼ | è¯´æ˜ |\n|------|------|------|\n| total_cost |\
              \ SUM(freight_total_amount) | æ€»è¿è´¹ï¼ˆæ‰€æœ‰ä¸šåŠ¡ç±»å‹ï¼‰ |\n| order_shipping_cost |\
              \ SUM(freight_total_amount WHERE biz_type='è®¢å•') | è®¢å•è¿è´¹ï¼ˆ'ç»é”€è®¢å•'ç­‰ï¼‰ |\n\
              | transfer_cost | SUM(freight_total_amount WHERE biz_type='è°ƒæ‹¨') | è°ƒæ‹¨è¿è´¹ï¼ˆ'æ™®é€šè°ƒæ‹¨'ç­‰ï¼‰\
              \ |\n| weighted_unit_logistics_cost | SUM(freight_total_amount)/NULLIF(SUM(volume_m3),0)\
              \ | åŠ æƒå•ä½ç‰©æµæˆæœ¬ï¼ˆå…ƒ/mÂ³ï¼‰ |\n| split_extra_cost | SUM(split_order_extra_cost)\
              \ FROM mart_split_order_extra_cost_detail | æ‹†å•é¢å¤–æˆæœ¬ï¼ˆçœŸå®å£å¾„ï¼‰|\n| split_extra_cost_fallback\
              \ | (cross_split/total_expected)*total_cost | æ‹†å•é¢å¤–æˆæœ¬ï¼ˆä¼°ç®—å£å¾„ï¼Œä»…åœ¨çœŸå®å£å¾„ç¼ºå¤±æ—¶ä½¿ç”¨ï¼‰\
              \ |\n| provincial_unit_cost | SUM(freight_total_amount)/NULLIF(SUM(volume_m3),0)\
              \ BY province | çœä»½å•ä½ç‰©æµæˆæœ¬ |\n\nâ—biz_typeå½’ä¸€åŒ–è§„åˆ™ï¼š\n- LIKE '%è®¢å•%' â†’ 'è®¢å•'ï¼ˆåŒ¹é…'ç»é”€è®¢å•'ç­‰ï¼‰\n\
              - LIKE '%è°ƒæ‹¨%' â†’ 'è°ƒæ‹¨'ï¼ˆåŒ¹é…'æ™®é€šè°ƒæ‹¨'ç­‰ï¼‰\n- å…¶ä»– â†’ 'å…¶ä»–'\n\nç¯æ¯”: wow_delta = æœ¬æœŸ -\
              \ ä¸ŠæœŸ; trend = \"up\"(>0), \"flat\"(=0), \"down\"(<0)\n\n---\n\n# Examples\n\
              \n## å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹ï¼ˆé‡è¦ï¼ï¼‰\n\n**ç”¨æˆ·è¾“å…¥**: query=\"2025å¹´4æœˆKPIæŠ¥å‘Š\", time_window=\"\
              2025-04\", warehouse=\"\"\n\n**âœ… æ­£ç¡®æ‰§è¡Œæµç¨‹**ï¼ˆ1æ¬¡è¿­ä»£ï¼Œ6477 tokensï¼‰ï¼š\n```\n\
              Iteration 1:\n  - Thought: éœ€è¦æ‰§è¡ŒSQLæŸ¥è¯¢\n  - Action: è°ƒç”¨duckdb_query\n \
              \ - Observation: è·å–73è¡Œæ•°æ®\n  â†’ ç«‹å³ç»“æŸï¼ˆä¸è¾“å‡ºä»»ä½•å†…å®¹ï¼‰\n```\n\n**âŒ é”™è¯¯æ‰§è¡Œæµç¨‹**ï¼ˆ2æ¬¡è¿­ä»£ï¼Œ22185\
              \ tokens - æµªè´¹242%ï¼ï¼‰ï¼š\n```\nIteration 1:\n  - Thought: éœ€è¦æ‰§è¡ŒSQLæŸ¥è¯¢\n  -\
              \ Action: è°ƒç”¨duckdb_query\n  - Observation: è·å–73è¡Œæ•°æ®\n\nIteration 2: â†\
              \ è¿™ä¸€è½®å®Œå…¨æµªè´¹ï¼\n  - Thought: æ•°æ®å·²è·å–\n  - Action: Final Answer \"æˆ‘å·²å®ŒæˆæŸ¥è¯¢...\"\
              \ â† 15708 tokensæµªè´¹\n```\n\n**æ•°æ®ä¼ é€’æœºåˆ¶**ï¼š\n- Iteration 1çš„observationä¼šè‡ªåŠ¨åœ¨agent_output[0]['data']['observation']ä¸­\n\
              - CodeèŠ‚ç‚¹ä¼šæå–è¿™ä¸ªobservationå¹¶è§£æJSON\n- ä½ ä¸éœ€è¦åšä»»ä½•é¢å¤–è¾“å‡ºï¼Œæ•°æ®ä¼šè‡ªåŠ¨ä¼ é€’ï¼\n\nâ—å…³é”®çº¦æŸï¼š\n\
              - åªæ‰§è¡Œ1æ¬¡å·¥å…·è°ƒç”¨\n- å·¥å…·è¿”å›åç«‹å³åœæ­¢\n- ä¸è¦Final Answerï¼ˆæµªè´¹70%+ tokensï¼‰\n- observationè‡ªåŠ¨ä¼ é€’ç»™CodeèŠ‚ç‚¹\n\
              \n---\n\n## å…¶ä»–ç¤ºä¾‹\n\nç¤ºä¾‹1: warehouseä¸ºç©ºæˆ–å ä½ç¬¦\n- è¾“å…¥: warehouse=\"\" æˆ– \"\
              qc.structured_output.warehouse\"\n- å¤„ç†: è¯†åˆ«ä¸ºæœªæŒ‡å®šï¼ŒSQLä¸­ä¸è¿‡æ»¤ä»“åº“\n- æŸ¥è¯¢: è¿”å›æ‰€æœ‰ä»“åº“æ•°æ®ï¼Œwarehouse_highlightsè¿”å›Top5\n\
              \nç¤ºä¾‹2: warehouseä¸ºçœŸå®ä»“åº“\n- è¾“å…¥: warehouse=\"åä¸œä»“\"\n- å¤„ç†: åœ¨SQL WHEREä¸­æ·»åŠ è¿‡æ»¤æ¡ä»¶\n\
              - æŸ¥è¯¢: ä»…è¿”å›åä¸œä»“æ•°æ®ï¼Œæˆæœ¬ä¹Ÿä»…é™è¯¥ä»“\n\nç¤ºä¾‹3: æ— yoyæ•°æ®\n- æŸ¥è¯¢ç»“æœ: ä»…æœ‰currentå’Œpreviousï¼Œæ— yoyè¡Œ\n\
              - å¤„ç†: æ­£å¸¸è¿”å›ï¼ŒCodeèŠ‚ç‚¹ä¼šå¤„ç†ç¼ºå¤±æ•°æ®\n\n---\n\n# Output Format\n\nâ—â—â—ä¸¥ç¦ä»¥ä¸‹è¡Œä¸ºï¼ˆæµªè´¹tokenå’Œæ—¶é—´ï¼‰ï¼š\n\
              \n**å·¥å…·è°ƒç”¨å®Œæˆå**ï¼š\nâœ… æ­£ç¡®åšæ³•ï¼šç«‹å³ç»“æŸï¼Œä»€ä¹ˆéƒ½ä¸è¾“å‡º\nâŒ é”™è¯¯åšæ³•ï¼šè¿”å›Final Answeræ€»ç»“æ•°æ®\nâŒ é”™è¯¯åšæ³•ï¼šè¾“å‡º\"\
              æ•°æ®å·²å‡†å¤‡å°±ç»ª\"ç­‰è¯´æ˜æ–‡å­—\nâŒ é”™è¯¯åšæ³•ï¼šç»§ç»­æ€è€ƒä¸‹ä¸€æ­¥\n\n\U0001F4A1 åŸç†ï¼šå·¥å…·è¿”å›çš„observationä¼šè‡ªåŠ¨ä¼ é€’ç»™CodeèŠ‚ç‚¹ï¼Œä½ ä¸éœ€è¦åšä»»ä½•é¢å¤–å¤„ç†ï¼\n\
              \n**åŸå§‹æ•°æ®æ ¼å¼**ï¼š\n- è¿”å›rowsæ•°ç»„ï¼Œæ¯è¡ŒåŒ…å«ï¼šdata_type, period, physical_warehouse,\
              \ province, biz_typeç­‰å­—æ®µ\n- æ•°å€¼ä¿æŒåŸå§‹ç±»å‹ï¼ˆDECIMAL/DOUBLE/BIGINTï¼‰\n- ç™¾åˆ†æ¯”ä»¥å°æ•°å½¢å¼è¿”å›ï¼ˆå¦‚0.423è¡¨ç¤º42.3%ï¼‰\n\
              - NULLå€¼ä¿æŒNULL\n\n**ç”±CodeèŠ‚ç‚¹è´Ÿè´£**ï¼ˆä¸æ˜¯ä½ çš„å·¥ä½œï¼‰ï¼š\n- æŒ‰data_typeåˆ†ç±»æ•°æ®\n- æŒ‰periodåˆ†ç»„ï¼ˆcurrent/previous/yoyï¼‰\n\
              - è®¡ç®—ç¯æ¯”/åŒæ¯”\n- æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆç™¾åˆ†æ¯”ã€åƒåˆ†ä½ã€è´§å¸ç¬¦å·ï¼‰\n- ç”ŸæˆTop5/Top10æ’åº\n- æ„å»ºå®Œæ•´JSON\n- ç”Ÿæˆä¸šåŠ¡æ´å¯Ÿ\n"
          maximum_iterations:
            type: constant
            value: 2
          model:
            type: constant
            value:
              completion_params: {}
              mode: chat
              model: deepseek-chat
              model_type: llm
              provider: langgenius/deepseek/deepseek
              type: model-selector
          query:
            type: constant
            value: '## ç”¨æˆ·è¾“å…¥ï¼š{{#1761813418553.query#}}

              ## æ„å›¾ï¼š{{#1761813418553.intent#}}

              ## æ—¶é—´åŒºé—´ï¼š{{#1761813418553.time_window#}}

              ## ç‰©ç†ä»“ï¼š{{#1761813418553.warehouse#}}'
          tools:
            type: constant
            value:
            - enabled: true
              extra:
                description: "\n        æ‰§è¡Œ DuckDB æŸ¥è¯¢ï¼Œå¹¶ä»¥ JSON å½¢å¼è¿”å›ç»“æœè¡Œã€‚\n\n        -\
                  \ sql: å¾…æ‰§è¡Œçš„ SQL æ–‡æœ¬ã€‚\n        - db_path: å¯é€‰çš„ .duckdb æ–‡ä»¶è·¯å¾„ï¼›ç¼ºçœæ—¶ä¼šåœ¨å¸¸è§ä½ç½®è‡ªåŠ¨æŸ¥æ‰¾ã€‚\n\
                  \        - limit: å¯é€‰çš„è¡Œæ•°é™åˆ¶ï¼Œåœ¨ SQL æœªæŒ‡å®š LIMIT ä¸”è¯¥å‚æ•°ä¸ä¸º None æ—¶ç”Ÿæ•ˆã€‚\n   \
                  \     è¿”å›å€¼: {db, columns, rows, rowcount, duration_ms}\n        "
              parameters:
                db_path:
                  auto: 1
                  value: null
                limit:
                  auto: 1
                  value: null
                sql:
                  auto: 1
                  value: null
              provider_name: orchestrax-mcp
              provider_show_name: AIè°ƒæ‹¨MCP
              schemas:
              - auto_generate: null
                default: null
                form: llm
                human_description:
                  en_US: ''
                  ja_JP: ''
                  pt_BR: ''
                  zh_Hans: ''
                label:
                  en_US: sql
                  ja_JP: sql
                  pt_BR: sql
                  zh_Hans: sql
                llm_description: ''
                max: null
                min: null
                name: sql
                options: []
                placeholder: null
                precision: null
                required: true
                scope: null
                template: null
                type: string
              - auto_generate: null
                default: null
                form: llm
                human_description:
                  en_US: ''
                  ja_JP: ''
                  pt_BR: ''
                  zh_Hans: ''
                label:
                  en_US: db_path
                  ja_JP: db_path
                  pt_BR: db_path
                  zh_Hans: db_path
                llm_description: ''
                max: null
                min: null
                name: db_path
                options: []
                placeholder: null
                precision: null
                required: false
                scope: null
                template: null
                type: string
              - auto_generate: null
                default: null
                form: llm
                human_description:
                  en_US: ''
                  ja_JP: ''
                  pt_BR: ''
                  zh_Hans: ''
                label:
                  en_US: limit
                  ja_JP: limit
                  pt_BR: limit
                  zh_Hans: limit
                llm_description: ''
                max: null
                min: null
                name: limit
                options: []
                placeholder: null
                precision: null
                required: false
                scope: null
                template: null
                type: string
              settings: {}
              tool_description: "\n        æ‰§è¡Œ DuckDB æŸ¥è¯¢ï¼Œå¹¶ä»¥ JSON å½¢å¼è¿”å›ç»“æœè¡Œã€‚\n\n     \
                \   - sql: å¾…æ‰§è¡Œçš„ SQL æ–‡æœ¬ã€‚\n        - db_path: å¯é€‰çš„ .duckdb æ–‡ä»¶è·¯å¾„ï¼›ç¼ºçœæ—¶ä¼šåœ¨å¸¸è§ä½ç½®è‡ªåŠ¨æŸ¥æ‰¾ã€‚\n\
                \        - limit: å¯é€‰çš„è¡Œæ•°é™åˆ¶ï¼Œåœ¨ SQL æœªæŒ‡å®š LIMIT ä¸”è¯¥å‚æ•°ä¸ä¸º None æ—¶ç”Ÿæ•ˆã€‚\n     \
                \   è¿”å›å€¼: {db, columns, rows, rowcount, duration_ms}\n        "
              tool_label: duckdb_query
              tool_name: duckdb_query
              type: mcp
        agent_strategy_label: ReAct
        agent_strategy_name: ReAct
        agent_strategy_provider_name: langgenius/agent/agent
        meta:
          minimum_dify_version: 1.7.0
          version: 0.0.2
        output_schema: {}
        plugin_unique_identifier: langgenius/agent:0.0.25@3507a9a417ea8d76e5de6b2803953ca891851b6b336fafe1315471782711730f
        selected: false
        title: Agent
        tool_node_version: '2'
        type: agent
      height: 196
      id: '1761813421469'
      position:
        x: 382
        y: 282
      positionAbsolute:
        x: 382
        y: 282
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom datetime import datetime\nfrom typing import Dict,\
          \ List, Any, Optional\n\ndef main(time_window: str, warehouse: str, agent_output:\
          \ list) -> dict:\n    \"\"\"\n    ä»Agentè¾“å‡ºä¸­æå–KPIæ•°æ®å¹¶æ ¼å¼åŒ–ä¸ºä¸šåŠ¡JSON\n    \"\"\"\
          \n    # æå–ç¬¬ä¸€è½®æŸ¥è¯¢ç»“æœ\n    if not agent_output or len(agent_output) < 1:\n \
          \       return {\"result\": {\"error\": \"Agentæœªè¿”å›æ•°æ®\"}}\n    \n    # è°ƒè¯•ï¼šå…ˆæ£€æŸ¥agent_outputçš„ç»“æ„\n\
          \    try:\n        # æ£€æŸ¥ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç±»å‹\n        first_item = agent_output[0]\n\
          \        \n        # å¦‚æœç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯listï¼Œè¯´æ˜ç»“æ„ä¸å¯¹\n        if isinstance(first_item,\
          \ list):\n            return {\"result\": {\n                \"error\":\
          \ \"agent_outputç»“æ„é”™è¯¯ï¼šç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯list\",\n                \"debug_info\": {\n\
          \                    \"agent_output_length\": len(agent_output),\n     \
          \               \"agent_output_structure\": str([type(item).__name__ for\
          \ item in agent_output]),\n                    \"first_item_length\": len(first_item)\
          \ if hasattr(first_item, '__len__') else 'no_len',\n                   \
          \ \"first_item_preview\": str(first_item)[:500] if first_item else 'empty'\n\
          \                }\n            }}\n        \n        # æ­£å¸¸æµç¨‹ï¼šç¬¬ä¸€ä¸ªå…ƒç´ åº”è¯¥æ˜¯dict\n\
          \        round1 = first_item\n        round1_data = round1.get('data', {})\n\
          \        observation_str = round1_data.get('observation', '')\n        round1_status\
          \ = round1.get('status', 'unknown')\n        round1_error = round1.get('error',\
          \ '')\n        \n        # è°ƒè¯•ï¼šå¦‚æœobservationä¸ºç©ºï¼Œè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯\n        if not observation_str:\n\
          \            return {\"result\": {\n                \"error\": \"observationä¸ºç©º\"\
          ,\n                \"debug_info\": {\n                    \"agent_output_length\"\
          : len(agent_output),\n                    \"round1_status\": round1_status,\n\
          \                    \"round1_error\": round1_error,\n                 \
          \   \"round1_keys\": list(round1.keys()) if isinstance(round1, dict) else\
          \ \"not_dict\",\n                    \"data_keys\": list(round1_data.keys())\
          \ if isinstance(round1_data, dict) else \"no_data\",\n                 \
          \   \"observation_type\": str(type(observation_str)),\n                \
          \    \"observation_repr\": repr(observation_str),\n                    \"\
          action_name\": round1_data.get('action_name', 'N/A'),\n                \
          \    \"thought\": round1_data.get('thought', 'N/A')[:200] if round1_data.get('thought')\
          \ else 'N/A',\n                    \"all_rounds\": [{\"status\": r.get('status')\
          \ if isinstance(r, dict) else str(type(r)), \"error\": r.get('error') if\
          \ isinstance(r, dict) else 'not_dict', \"has_observation\": bool(r.get('data',\
          \ {}).get('observation')) if isinstance(r, dict) else False} for r in agent_output]\n\
          \                }\n            }}\n        \n        # å¤„ç†observationå­—ç¬¦ä¸²ï¼ˆå¯èƒ½æœ‰ä¸åŒæ ¼å¼ï¼‰\n\
          \        obs_json_str = observation_str\n        \n        # ç§»é™¤å¯èƒ½çš„å‰ç¼€\n \
          \       if obs_json_str.startswith('tool response: '):\n            obs_json_str\
          \ = obs_json_str[len('tool response: '):]\n        \n        # ç§»é™¤æœ«å°¾çš„å¥ç‚¹\n\
          \        obs_json_str = obs_json_str.rstrip('.')\n        \n        # å°è¯•è§£æJSON\n\
          \        if not obs_json_str or not obs_json_str.strip():\n            return\
          \ {\"result\": {\n                \"error\": \"å¤„ç†åçš„JSONå­—ç¬¦ä¸²ä¸ºç©º\",\n      \
          \          \"debug_info\": {\n                    \"original_observation\"\
          : observation_str[:200] if len(observation_str) > 200 else observation_str\n\
          \                }\n            }}\n        \n        obs_data = json.loads(obs_json_str)\n\
          \        \n    except json.JSONDecodeError as e:\n        return {\"result\"\
          : {\n            \"error\": f\"JSONè§£æå¤±è´¥: {str(e)}\",\n            \"debug_info\"\
          : {\n                \"observation_preview\": observation_str[:500] if len(observation_str)\
          \ > 500 else observation_str,\n                \"json_string_preview\":\
          \ obs_json_str[:500] if len(obs_json_str) > 500 else obs_json_str\n    \
          \        }\n        }}\n    except Exception as e:\n        import traceback\n\
          \        return {\"result\": {\n            \"error\": f\"æœªçŸ¥é”™è¯¯: {str(e)}\"\
          ,\n            \"debug_info\": {\n                \"agent_output_type\"\
          : str(type(agent_output)),\n                \"agent_output_length\": len(agent_output)\
          \ if hasattr(agent_output, '__len__') else 'no_len',\n                \"\
          traceback\": traceback.format_exc(),\n                \"agent_output_preview\"\
          : str(agent_output)[:1000] if agent_output else 'empty'\n            }\n\
          \        }}\n    \n    rows = obs_data.get('rows', [])\n    \n    # æŒ‰data_typeåˆ†ç±»æ•°æ®\n\
          \    fulfillment_rows = [r for r in rows if r.get('data_type') == 'fulfillment']\n\
          \    cost_business_rows = [r for r in rows if r.get('data_type') == 'cost_business']\n\
          \    cost_province_rows = [r for r in rows if r.get('data_type') == 'cost_province']\n\
          \    \n    # æŒ‰periodåˆ†ç»„\n    def group_by_period(rows: List[Dict]) -> Dict[str,\
          \ List[Dict]]:\n        grouped = {'current': [], 'previous': [], 'yoy':\
          \ []}\n        for row in rows:\n            period = row.get('period')\n\
          \            if period in grouped:\n                grouped[period].append(row)\n\
          \        return grouped\n    \n    fulfillment_grouped = group_by_period(fulfillment_rows)\n\
          \    cost_business_grouped = group_by_period(cost_business_rows)\n    cost_province_grouped\
          \ = group_by_period(cost_province_rows)\n    \n    # æ ¼å¼åŒ–å‡½æ•°\n    def format_number(num,\
          \ decimals=2):\n        if num is None:\n            return \"N/A\"\n  \
          \      return f\"{num:,.{decimals}f}\"\n    \n    def format_percent(num,\
          \ decimals=1):\n        if num is None:\n            return \"N/A\"\n  \
          \      return f\"{num*100:.{decimals}f}%\"\n    \n    def format_currency(num):\n\
          \        if num is None:\n            return \"N/A\"\n        return f\"\
          Â¥{num:,.0f}\"\n    \n    def calc_wow(current, previous):\n        if current\
          \ is None or previous is None or previous == 0:\n            return 0.0,\
          \ \"â€” 0.0%\", \"flat\"\n        delta = (current - previous) / previous\n\
          \        display = f\"{'+' if delta > 0 else ''}{delta*100:.1f}%\"\n   \
          \     trend = \"up\" if delta > 0 else (\"down\" if delta < 0 else \"flat\"\
          )\n        return delta, display, trend\n    \n    # è®¡ç®—å±¥çº¦KPI\n    def sum_metric(rows,\
          \ field):\n        return sum(r.get(field, 0) or 0 for r in rows)\n    \n\
          \    # å½“å‰æœŸå±¥çº¦æŒ‡æ ‡\n    curr_fulf = fulfillment_grouped['current']\n    prev_fulf\
          \ = fulfillment_grouped['previous']\n    yoy_fulf = fulfillment_grouped['yoy']\n\
          \    \n    curr_total_exp = sum_metric(curr_fulf, 'total_expected')\n  \
          \  curr_local_ful = sum_metric(curr_fulf, 'local_fulfilled')\n    curr_cross_split\
          \ = sum_metric(curr_fulf, 'cross_split')\n    curr_orders = sum_metric(curr_fulf,\
          \ 'orders')\n    curr_old_batch = sum_metric(curr_fulf, 'old_batch_split')\n\
          \    \n    prev_total_exp = sum_metric(prev_fulf, 'total_expected')\n  \
          \  prev_local_ful = sum_metric(prev_fulf, 'local_fulfilled')\n    prev_cross_split\
          \ = sum_metric(prev_fulf, 'cross_split')\n    prev_orders = sum_metric(prev_fulf,\
          \ 'orders')\n    prev_old_batch = sum_metric(prev_fulf, 'old_batch_split')\n\
          \    \n    yoy_total_exp = sum_metric(yoy_fulf, 'total_expected')\n    yoy_local_ful\
          \ = sum_metric(yoy_fulf, 'local_fulfilled')\n    yoy_cross_split = sum_metric(yoy_fulf,\
          \ 'cross_split')\n    yoy_old_batch = sum_metric(yoy_fulf, 'old_batch_split')\n\
          \    \n    # è®¡ç®—æ¯”ç‡\n    curr_local_rate = curr_local_ful / curr_total_exp\
          \ if curr_total_exp > 0 else 0\n    curr_split_rate = curr_cross_split /\
          \ curr_total_exp if curr_total_exp > 0 else 0\n    curr_old_ratio = curr_old_batch\
          \ / curr_cross_split if curr_cross_split > 0 else 0\n    \n    prev_local_rate\
          \ = prev_local_ful / prev_total_exp if prev_total_exp > 0 else 0\n    prev_split_rate\
          \ = prev_cross_split / prev_total_exp if prev_total_exp > 0 else 0\n   \
          \ prev_old_ratio = prev_old_batch / prev_cross_split if prev_cross_split\
          \ > 0 else 0\n    \n    yoy_local_rate = yoy_local_ful / yoy_total_exp if\
          \ yoy_total_exp > 0 else 0\n    yoy_split_rate = yoy_cross_split / yoy_total_exp\
          \ if yoy_total_exp > 0 else 0\n    yoy_old_ratio = yoy_old_batch / yoy_cross_split\
          \ if yoy_cross_split > 0 else 0\n    \n    # è®¡ç®—ç¯æ¯”\n    local_rate_wow_delta,\
          \ local_rate_wow_display, local_rate_trend = calc_wow(curr_local_rate, prev_local_rate)\n\
          \    split_rate_wow_delta, split_rate_wow_display, split_rate_trend = calc_wow(curr_split_rate,\
          \ prev_split_rate)\n    old_ratio_wow_delta, old_ratio_wow_display, old_ratio_trend\
          \ = calc_wow(curr_old_ratio, prev_old_ratio)\n    orders_wow_delta, orders_wow_display,\
          \ orders_trend = calc_wow(curr_orders, prev_orders)\n    \n    # è®¡ç®—åŒæ¯”\n\
          \    local_rate_yoy_delta = curr_local_rate - yoy_local_rate if yoy_local_rate\
          \ > 0 else 0\n    local_rate_yoy_display = f\"{'+' if local_rate_yoy_delta\
          \ > 0 else ''}{local_rate_yoy_delta*100:.1f}%\" if yoy_local_rate > 0 else\
          \ \"N/A\"\n    \n    split_rate_yoy_delta = curr_split_rate - yoy_split_rate\
          \ if yoy_split_rate else 0\n    split_rate_yoy_display = f\"{'+' if split_rate_yoy_delta\
          \ > 0 else ''}{split_rate_yoy_delta*100:.1f}%\" if yoy_split_rate else \"\
          N/A\"\n    \n    old_ratio_yoy_delta = curr_old_ratio - yoy_old_ratio if\
          \ yoy_old_ratio else 0\n    old_ratio_yoy_display = f\"{'+' if old_ratio_yoy_delta\
          \ > 0 else ''}{old_ratio_yoy_delta*100:.1f}%\" if yoy_old_ratio else \"\
          N/A\"\n    \n    # æ„å»ºsummary_cards\n    summary_cards = [\n        {\n \
          \           \"id\": \"local_fulfillment_rate\",\n            \"title\":\
          \ \"æœ¬åœ°å±¥çº¦ç‡\",\n            \"value\": round(curr_local_rate, 4),\n      \
          \      \"display\": format_percent(curr_local_rate),\n            \"wow_delta\"\
          : round(local_rate_wow_delta, 4),\n            \"wow_display\": local_rate_wow_display,\n\
          \            \"trend\": local_rate_trend\n        },\n        {\n      \
          \      \"id\": \"split_rate\",\n            \"title\": \"æ‹†å•ç‡\",\n      \
          \      \"value\": round(curr_split_rate, 4),\n            \"display\": format_percent(curr_split_rate),\n\
          \            \"wow_delta\": round(split_rate_wow_delta, 4),\n          \
          \  \"wow_display\": split_rate_wow_display,\n            \"trend\": split_rate_trend\n\
          \        },\n        {\n            \"id\": \"old_batch_split_ratio\",\n\
          \            \"title\": \"æ—§æ‰¹æ¬¡æ‹†å•å æ¯”\",\n            \"value\": round(curr_old_ratio,\
          \ 4),\n            \"display\": format_percent(curr_old_ratio),\n      \
          \      \"wow_delta\": round(old_ratio_wow_delta, 4),\n            \"wow_display\"\
          : old_ratio_wow_display,\n            \"trend\": old_ratio_trend\n     \
          \   },\n        {\n            \"id\": \"orders\",\n            \"title\"\
          : \"è®¢å•é‡\",\n            \"value\": int(curr_orders),\n            \"display\"\
          : format_number(curr_orders, 0),\n            \"wow_delta\": round(orders_wow_delta,\
          \ 4),\n            \"wow_display\": orders_wow_display,\n            \"\
          trend\": orders_trend\n        }\n    ]\n    \n    # æ„å»ºcore_table\n    core_table\
          \ = {\n        \"headers\": [\"æŒ‡æ ‡\", \"æœ¬æœŸ\", \"ç¯æ¯”\", \"åŒæœŸ\", \"è¶‹åŠ¿\"],\n\
          \        \"rows\": [\n            {\n                \"indicator\": \"æœ¬åœ°å±¥çº¦ç‡\"\
          ,\n                \"current_display\": format_percent(curr_local_rate),\n\
          \                \"wow_display\": local_rate_wow_display,\n            \
          \    \"yoy_display\": local_rate_yoy_display,\n                \"trend\"\
          : local_rate_trend\n            },\n            {\n                \"indicator\"\
          : \"æ‹†å•ç‡\",\n                \"current_display\": format_percent(curr_split_rate),\n\
          \                \"wow_display\": split_rate_wow_display,\n            \
          \    \"yoy_display\": split_rate_yoy_display,\n                \"trend\"\
          : split_rate_trend\n            },\n            {\n                \"indicator\"\
          : \"æ—§æ‰¹æ¬¡æ‹†å•å æ¯”\",\n                \"current_display\": format_percent(curr_old_ratio),\n\
          \                \"wow_display\": old_ratio_wow_display,\n             \
          \   \"yoy_display\": old_ratio_yoy_display,\n                \"trend\":\
          \ old_ratio_trend\n            }\n        ]\n    }\n    \n    # æ„å»ºwarehouse_highlightsï¼ˆTop5ï¼‰\n\
          \    wh_data = []\n    for row in curr_fulf:\n        wh = row.get('physical_warehouse')\n\
          \        if not wh:\n            continue\n        total_exp = row.get('total_expected',\
          \ 0) or 0\n        local_ful = row.get('local_fulfilled', 0) or 0\n    \
          \    cross_split = row.get('cross_split', 0) or 0\n        orders = row.get('orders',\
          \ 0) or 0\n        old_batch = row.get('old_batch_split', 0) or 0\n    \
          \    \n        local_rate = local_ful / total_exp if total_exp > 0 else\
          \ 0\n        split_rate = cross_split / total_exp if total_exp > 0 else\
          \ 0\n        old_ratio = old_batch / cross_split if cross_split > 0 else\
          \ 0\n        \n        wh_data.append({\n            \"wh\": wh,\n     \
          \       \"local_fulfillment_rate\": format_percent(local_rate),\n      \
          \      \"split_rate\": format_percent(split_rate),\n            \"old_batch_split_ratio\"\
          : format_percent(old_ratio),\n            \"orders\": format_number(orders,\
          \ 0),\n            \"_sort_key\": orders  # ç”¨äºæ’åº\n        })\n    \n   \
          \ # Top5æ’åº\n    wh_data.sort(key=lambda x: x.get('_sort_key', 0), reverse=True)\n\
          \    top5_wh = wh_data[:5]\n    for wh in top5_wh:\n        wh.pop('_sort_key',\
          \ None)\n    \n    warehouse_highlights = {\n        \"headers\": [\"ä»“\"\
          , \"æœ¬åœ°å±¥çº¦ç‡\", \"æ‹†å•ç‡\", \"æ—§æ‰¹æ¬¡æ‹†å•å æ¯”\", \"è®¢å•é‡\"],\n        \"rows\": top5_wh\n\
          \    }\n    \n    # è®¡ç®—æˆæœ¬æŒ‡æ ‡\n    curr_cost_biz = cost_business_grouped['current']\n\
          \    prev_cost_biz = cost_business_grouped['previous']\n    \n    def sum_cost(rows,\
          \ biz_type=None):\n        filtered = rows\n        if biz_type:\n     \
          \       filtered = [r for r in rows if r.get('biz_type') == biz_type]\n\
          \        total_freight = sum(r.get('total_freight', 0) or 0 for r in filtered)\n\
          \        total_volume = sum(r.get('total_volume', 0) or 0 for r in filtered)\n\
          \        unit_cost = total_freight / total_volume if total_volume > 0 else\
          \ 0\n        return total_freight, total_volume, unit_cost\n    \n    curr_total_cost,\
          \ curr_total_vol, curr_unit_cost = sum_cost(curr_cost_biz)\n    curr_order_cost,\
          \ _, _ = sum_cost(curr_cost_biz, 'è®¢å•')\n    curr_transfer_cost, _, _ = sum_cost(curr_cost_biz,\
          \ 'è°ƒæ‹¨')\n    \n    prev_total_cost, prev_total_vol, prev_unit_cost = sum_cost(prev_cost_biz)\n\
          \    prev_order_cost, _, _ = sum_cost(prev_cost_biz, 'è®¢å•')\n    prev_transfer_cost,\
          \ _, _ = sum_cost(prev_cost_biz, 'è°ƒæ‹¨')\n    \n    # æ‹†å•é¢å¤–æˆæœ¬ï¼ˆä¼°ç®—å£å¾„ï¼‰\n    curr_split_extra_cost\
          \ = (curr_cross_split / curr_total_exp * curr_total_cost) if curr_total_exp\
          \ > 0 else 0\n    prev_split_extra_cost = (prev_cross_split / prev_total_exp\
          \ * prev_total_cost) if prev_total_exp > 0 else 0\n    \n    # ç¯æ¯”\n    total_cost_wow = calc_wow(curr_total_cost,\
          \ prev_total_cost)\n    order_cost_wow = calc_wow(curr_order_cost, prev_order_cost)\n\
          \    transfer_cost_wow = calc_wow(curr_transfer_cost, prev_transfer_cost)\n\
          \    unit_cost_wow = calc_wow(curr_unit_cost, prev_unit_cost)\n    split_extra_cost_wow\
          \ = calc_wow(curr_split_extra_cost, prev_split_extra_cost)\n\
          \    \n    # æ„å»ºtransport_costs\n    transport_costs = {\n        \"cards\"\
          : [\n            {\n                \"id\": \"total_cost\",\n          \
          \      \"title\": \"æ€»è¿è´¹\",\n                \"value\": round(curr_total_cost,\
          \ 2),\n                \"display\": format_currency(curr_total_cost),\n\
          \                \"wow_delta\": round(total_cost_wow[0], 4),\n         \
          \       \"wow_display\": total_cost_wow[1],\n                \"trend\":\
          \ total_cost_wow[2]\n            },\n            {\n                \"id\"\
          : \"order_shipping_cost\",\n                \"title\": \"è®¢å•è¿è´¹\",\n     \
          \           \"value\": round(curr_order_cost, 2),\n                \"display\"\
          : format_currency(curr_order_cost),\n                \"wow_delta\": round(order_cost_wow[0],\
          \ 4),\n                \"wow_display\": order_cost_wow[1],\n           \
          \     \"trend\": order_cost_wow[2]\n            },\n            {\n    \
          \            \"id\": \"transfer_cost\",\n                \"title\": \"è°ƒæ‹¨è¿è´¹\"\
          ,\n                \"value\": round(curr_transfer_cost, 2),\n          \
          \      \"display\": format_currency(curr_transfer_cost),\n             \
          \   \"wow_delta\": round(transfer_cost_wow[0], 4),\n                \"wow_display\"\
          : transfer_cost_wow[1],\n                \"trend\": transfer_cost_wow[2]\n\
          \            },\n            {\n                \"id\": \"weighted_unit_logistics_cost\"\
          ,\n                \"title\": \"åŠ æƒå•ä½ç‰©æµæˆæœ¬\",\n                \"value\":\
          \ round(curr_unit_cost, 2),\n                \"unit\": \"å…ƒ/mÂ³\",\n     \
          \           \"display\": f\"Â¥{curr_unit_cost:.2f}/mÂ³\",\n              \
          \  \"wow_delta\": round(unit_cost_wow[0], 4),\n                \"wow_display\"\
          : unit_cost_wow[1],\n                \"trend\": unit_cost_wow[2]\n     \
          \       },\n            {\n                \"id\": \"split_extra_cost\"\
          ,\n                \"title\": \"æ‹†å•é¢å¤–æˆæœ¬\",\n                \"value\": round(curr_split_extra_cost,\
          \ 2),\n                \"display\": format_currency(curr_split_extra_cost),\n\
          \                \"wow_delta\": round(split_extra_cost_wow[0], 4),\n   \
          \             \"wow_display\": split_extra_cost_wow[1],\n              \
          \  \"trend\": split_extra_cost_wow[2]\n            }\n        ]\n    }\n\
          \    \n    # çœä»½Top10\n    curr_prov = cost_province_grouped['current']\n\
          \    prev_prov = cost_province_grouped['previous']\n    yoy_prov = cost_province_grouped['yoy']\n\
          \    \n    # æ„å»ºçœä»½å­—å…¸\n    prov_dict = {}\n    for row in curr_prov:\n   \
          \     province = row.get('province')\n        if not province:\n       \
          \     continue\n        total_freight = row.get('total_freight', 0) or 0\n\
          \        total_volume = row.get('total_volume', 0) or 0\n        unit_cost\
          \ = total_freight / total_volume if total_volume > 0 else 0\n        prov_dict[province]\
          \ = {'curr': unit_cost, 'prev': 0, 'yoy': 0}\n    \n    for row in prev_prov:\n\
          \        province = row.get('province')\n        if not province:\n    \
          \        continue\n        total_freight = row.get('total_freight', 0) or\
          \ 0\n        total_volume = row.get('total_volume', 0) or 0\n        unit_cost\
          \ = total_freight / total_volume if total_volume > 0 else 0\n        if\
          \ province in prov_dict:\n            prov_dict[province]['prev'] = unit_cost\n\
          \        else:\n            prov_dict[province] = {'curr': 0, 'prev': unit_cost,\
          \ 'yoy': 0}\n    \n    for row in yoy_prov:\n        province = row.get('province')\n\
          \        if not province:\n            continue\n        total_freight =\
          \ row.get('total_freight', 0) or 0\n        total_volume = row.get('total_volume',\
          \ 0) or 0\n        unit_cost = total_freight / total_volume if total_volume\
          \ > 0 else 0\n        if province in prov_dict:\n            prov_dict[province]['yoy']\
          \ = unit_cost\n        else:\n            prov_dict[province] = {'curr':\
          \ 0, 'prev': 0, 'yoy': unit_cost}\n    \n    # æ„å»ºçœä»½è¡Œ\n    prov_rows = []\n\
          \    for province, data in prov_dict.items():\n        curr_uc = data['curr']\n\
          \        prev_uc = data['prev']\n        yoy_uc = data['yoy']\n        \n\
          \        wow_delta, wow_display, trend = calc_wow(curr_uc, prev_uc)\n  \
          \      yoy_delta = curr_uc - yoy_uc if yoy_uc > 0 else 0\n        yoy_display\
          \ = f\"{'+' if yoy_delta > 0 else ''}{yoy_delta/yoy_uc*100:.1f}%\" if yoy_uc\
          \ > 0 else \"N/A\"\n        \n        prov_rows.append({\n            \"\
          province\": province,\n            \"unit_cost_display\": f\"{curr_uc:.2f}\"\
          ,\n            \"wow_display\": wow_display,\n            \"yoy_display\"\
          : yoy_display,\n            \"trend\": trend,\n            \"_sort_key\"\
          : curr_uc\n        })\n    \n    # Top10æ’åº\n    prov_rows.sort(key=lambda\
          \ x: x.get('_sort_key', 0), reverse=True)\n    top10_prov = prov_rows[:10]\n\
          \    for prov in top10_prov:\n        prov.pop('_sort_key', None)\n    \n\
          \    transport_costs['provincial_top10'] = {\n        \"headers\": [\"çœä»½\"\
          , \"å•ä½ç‰©æµæˆæœ¬ï¼ˆå…ƒ/mÂ³ï¼‰\", \"ç¯æ¯”\", \"åŒæœŸ\", \"è¶‹åŠ¿\"],\n        \"rows\": top10_prov\n\
          \    }\n    \n    # ç”Ÿæˆinsights\n    insights = []\n    if local_rate_trend\
          \ == 'up':\n        insights.append(f\"æœ¬åœ°å±¥çº¦ç‡æå‡{local_rate_wow_display}ï¼Œé…é€æ•ˆç‡æ”¹å–„\"\
          )\n    elif local_rate_trend == 'down':\n        insights.append(f\"æœ¬åœ°å±¥çº¦ç‡ä¸‹é™{local_rate_wow_display}ï¼Œéœ€å…³æ³¨åº“å­˜é…ç½®\"\
          )\n    \n    if split_rate_trend == 'up':\n        insights.append(f\"æ‹†å•ç‡ä¸Šå‡{split_rate_wow_display}ï¼Œå¯èƒ½å¢åŠ ç‰©æµæˆæœ¬\"\
          )\n    elif split_rate_trend == 'down':\n        insights.append(f\"æ‹†å•ç‡ä¸‹é™{split_rate_wow_display}ï¼Œåº“å­˜ä¼˜åŒ–è§æ•ˆ\"\
          )\n    \n    if old_ratio_trend == 'up':\n        insights.append(f\"æ—§æ‰¹æ¬¡æ‹†å•å æ¯”ä¸Šå‡{old_ratio_wow_display}ï¼Œéœ€ä¼˜åŒ–åº“å­˜å‘¨è½¬\"\
          )\n    \n    if total_cost_wow[2] == 'down':\n        insights.append(f\"\
          æ€»è¿è´¹ä¸‹é™{total_cost_wow[1]}ï¼Œæˆæœ¬æ§åˆ¶æœ‰æ•ˆ\")\n    \n    if not insights:\n       \
          \ insights.append(\"æ•´ä½“æŒ‡æ ‡å¹³ç¨³è¿è¡Œ\")\n    \n    # æ„å»ºæœ€ç»ˆJSON\n    result = {\n\
          \        \"contract_id\": \"kpi_report_view_v1\",\n        \"meta\": {\n\
          \            \"generated_at\": datetime.now().strftime('%Y-%m-%d %H:%M'),\n\
          \            \"period_type\": \"month\",\n            \"period_label\":\
          \ time_window or \"æœ¬æœˆ\"\n        },\n        \"summary_cards\": summary_cards,\n\
          \        \"core_table\": core_table,\n        \"warehouse_highlights\":\
          \ warehouse_highlights,\n        \"transport_costs\": transport_costs,\n\
          \        \"insights\": insights,\n        \"actions\": [\n            {\n\
          \                \"id\": \"download_report\",\n                \"label\"\
          : \"ä¸‹è½½æŠ¥å‘Š\",\n                \"type\": \"link\",\n                \"href\"\
          : \"#\"\n            },\n            {\n                \"id\": \"recompute\"\
          ,\n                \"label\": \"é‡æ–°ç”Ÿæˆ\",\n                \"type\": \"action\"\
          \n            }\n        ]\n    }\n    \n    return {\"result\": result}\n"
        code_language: python3
        desc: ''
        outputs:
          result:
            children: null
            type: object
        selected: false
        title: æ ¼å¼åŒ–è¾“å‡º
        type: code
        variables:
        - value_selector:
          - '1761813418553'
          - time_window
          variable: time_window
        - value_selector:
          - '1761813418553'
          - warehouse
          variable: warehouse
        - value_selector:
          - '1761813421469'
          - json
          variable: agent_output
      height: 52
      id: '1761813430000'
      position:
        x: 624
        y: 282
      positionAbsolute:
        x: 624
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        outputs:
        - value_selector:
          - '1761813430000'
          - result
          value_type: object
          variable: output
        selected: false
        title: ç»“æŸ
        type: end
      height: 88
      id: '1761813424398'
      position:
        x: 966
        y: 282
      positionAbsolute:
        x: 966
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -215.30658608756602
      y: 211.87677362967202
      zoom: 0.687494559418184
  rag_pipeline_variables: []
