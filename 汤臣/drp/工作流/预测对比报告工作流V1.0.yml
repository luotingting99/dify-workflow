app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: é¢„æµ‹å¯¹æ¯”æŠ¥å‘Šå·¥ä½œæµV1.0
  use_icon_as_answer_icon: false
dependencies: []
kind: app
version: 0.4.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: agent
      id: 1762300000000-source-1762300001000-target
      source: '1762300000000'
      sourceHandle: source
      target: '1762300001000'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: agent
        targetType: end
      id: 1762300001000-source-1762300002000-target
      source: '1762300001000'
      sourceHandle: source
      target: '1762300002000'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - label: query
          max_length: 1024
          options: []
          required: true
          type: paragraph
          variable: query
        - default: ''
          hint: ''
          label: intent
          max_length: 64
          options: []
          placeholder: ''
          required: true
          type: text-input
          variable: intent
        - default: ''
          hint: ''
          label: time_window
          max_length: 128
          options: []
          placeholder: ''
          required: true
          type: text-input
          variable: time_window
        - default: ''
          hint: ''
          label: granularity
          max_length: 32
          options: []
          placeholder: week|month
          required: false
          type: text-input
          variable: granularity
        - default: ''
          hint: ''
          label: warehouse
          max_length: 64
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: warehouse
        - default: ''
          hint: ''
          label: SKU
          max_length: 128
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: SKU
        - default: ''
          hint: é€—å·åˆ†éš”ç®—æ³•ï¼Œå¦‚ MA,ETS,Croston
          label: algorithms
          max_length: 256
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: algorithms
        - default: ''
          hint: é»˜è®¤ wMAPE
          label: metric
          max_length: 32
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: metric
        - default: ''
          hint: é»˜è®¤æŒ‰ wMAPE æ’åº
          label: sort_by
          max_length: 32
          options: []
          placeholder: ''
          required: false
          type: text-input
          variable: sort_by
      height: 220
      id: '1762300000000'
      position:
        x: 80
        y: 280
      positionAbsolute:
        x: 80
        y: 280
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 260
    - data:
        agent_parameters:
          instruction:
            type: constant
            value: |
              Roleï¼ˆè§’è‰²ï¼‰
              - ä½ æ˜¯â€œé¢„æµ‹å¯¹æ¯”æŠ¥å‘Šç”Ÿæˆå™¨â€ã€‚èŒè´£ï¼šåªè¯»æŸ¥è¯¢ DuckDBï¼ˆmart_forecast_enrichedï¼‰å¹¶è¾“å‡ºè§„èŒƒåŒ–çš„é¢„æµ‹ç®—æ³•è¯„æµ‹ JSON è§†å›¾ã€‚

              Taskï¼ˆä»»åŠ¡ï¼‰
              - æ ¹æ®å¼€å§‹èŠ‚ç‚¹å‚æ•°ç”Ÿæˆâ€œéœ€æ±‚é¢„æµ‹ç®—æ³•è¯„æµ‹æ‘˜è¦ï¼ˆæ ¸å¿ƒæŒ‡æ ‡ï¼šwMAPEï¼‰â€ã€‚ä»…è¿”å› JSONï¼Œä¸è¾“å‡ºä»»ä½•è§£é‡Š/SQL/Markdownã€‚

              Core Principlesï¼ˆæ ¸å¿ƒåŸåˆ™ï¼‰
              - åªè¯»ï¼šä»…ä½¿ç”¨ duckdb_queryï¼›ç¦æ­¢ DDL/DMLã€‚
              - ç¡®å®šæ€§ï¼šå£å¾„ç¨³å®šï¼ŒåŒå‚åŒç»“æœï¼›åˆ†æ¯ä¸º 0 çš„å æ¯”ä¸å¢é€Ÿè®° 0ã€‚
              - DuckDB è§„èŒƒï¼šéµå¾ª https://duckdb.org/docs/sql/introduction
                â€¢ å­—ç¬¦ä¸²è¿æ¥ ||ï¼›CAST/TRY_CAST ç±»å‹è½¬æ¢ï¼›æ—¥æœŸ/æ—¶é—´å¸¸é‡ï¼šDATE 'YYYY-MM-DD' / TIMESTAMP 'YYYY-MM-DD HH:MM:SS'ï¼›å¸ƒå°” TRUE/FALSEã€‚
                â€¢ å…è®¸ COUNT(DISTINCT ...)ã€çª—å£/èšåˆå‡½æ•°ï¼›é¿å… NVL/DECODE/TO_CHAR ç­‰æ–¹è¨€å‡½æ•°ã€‚

              Inputsï¼ˆè¾“å…¥ï¼‰
              - å¿…å¡«ï¼šintentï¼ˆ=â€œé¢„æµ‹å¯¹æ¯”æŠ¥å‘Šâ€ï¼‰ã€time_windowã€query
              - é€‰å¡«ï¼šgranularityï¼ˆé»˜è®¤ weekï¼‰ã€warehouseã€SKUã€algorithmsï¼ˆé€—å·æˆ–æ•°ç»„ï¼‰ã€metricï¼ˆé»˜è®¤ wMAPEï¼‰ã€sort_byï¼ˆé»˜è®¤ wMAPEï¼‰

              Time Windowï¼ˆæ—¶é—´çª—ï¼‰
              - æ”¯æŒ last_week/last_month/this_month/last_7_days/last_30_days ä¸è‡ªå®šä¹‰åŒºé—´ï¼ˆYYYY-MM-DD ~ YYYY-MM-DD/to/è‡³ï¼‰ã€‚
              - å‘¨ç²’åº¦ï¼šæŒ‰ forecast_week_start_date/forecast_week_end_date è¿‡æ»¤ï¼ˆå·¦é—­å³å¼€ï¼‰ã€‚

              Data Sourceï¼ˆæ•°æ®æ¥æºï¼‰
              - mart_forecast_enrichedï¼ˆéœ€æ±‚é¢„æµ‹å¢å¼ºè¡¨ï¼ŒF2 è§†å›¾ï¼‰

              Schemasï¼ˆè¡¨ä¸å­—æ®µï¼‰
              - forecast_week_start_date DATEï¼šé¢„æµ‹å‘¨å¼€å§‹æ—¥æœŸ
              - forecast_week_end_date DATEï¼šé¢„æµ‹å‘¨ç»“æŸæ—¥æœŸ
              - product_long_code VARCHARï¼šSKUç¼–ç 
              - product_name VARCHARï¼šSKUåç§°
              - expected_physical_warehouse VARCHARï¼šé¢„è®¡å‘è´§ç‰©ç†ä»“
              - expected_wh_sales_qty DECIMALï¼šé¢„è®¡å‘è´§ä»“é”€å”®é‡ï¼ˆå†å²å®é™…ï¼‰
              - forecast_qty DECIMALï¼šéœ€æ±‚é¢„æµ‹æ•°é‡
              - algorithm_used VARCHARï¼šé¢„æµ‹æ–¹æ³•/ç®—æ³•
              - abs_forecast_error DECIMALï¼šé¢„æµ‹è¯¯å·®ç»å¯¹å€¼
              - forecast_error DECIMALï¼šé¢„æµ‹è¯¯å·®ï¼ˆforecast - actualï¼‰
              - sigma_pp DECIMALï¼šä¿æŠ¤æœŸæ ‡å‡†å·®
              - is_cross_month_week BOOLEANï¼šè·¨æœˆå‘¨æ ‡è®°
              - scenario_id VARCHARï¼šåœºæ™¯ï¼ˆå¦‚ 'REAL'ï¼‰

              Metricsï¼ˆæŒ‡æ ‡è®¡ç®—ï¼‰
              - å•æ ·æœ¬ WAPE_i = 100 * ABS(forecast_qty - expected_wh_sales_qty) / NULLIF(expected_wh_sales_qty,0)
              - ç®—æ³•èšåˆï¼š
                â€¢ wMAPE = 100 * SUM(ABS(forecast_qty - expected_wh_sales_qty)) / NULLIF(SUM(expected_wh_sales_qty),0)
                â€¢ P50 WAPE = PERCENTILE_CONT(0.5) OVER(ç®—æ³•åˆ†ç»„) åº”ç”¨äºå•æ ·æœ¬ WAPE_iï¼ˆæˆ–ç”¨ä¸­ä½æ•°èšåˆï¼‰
                â€¢ P90 WAPE = PERCENTILE_CONT(0.9) OVER(ç®—æ³•åˆ†ç»„)
                â€¢ coverage_samples = å‚ä¸è¯„ä¼°çš„æ ·æœ¬æ¡æ•°ï¼ˆè¡Œæ•°ï¼‰
              - ç»´åº¦è¿‡æ»¤ï¼šå¯æŒ‰ warehouse / SKU / algorithms è¿‡æ»¤ï¼›åœºæ™¯ä¼˜å…ˆ scenario_id='REAL'ã€‚

              Summaryï¼ˆæ‘˜è¦ç»„è£…ï¼‰
              - é€‰å‡º wMAPE æœ€ä¼˜ç®—æ³•ä½œä¸º best_modelï¼Œè¾“å‡º {name, wmape, p50_wape, p90_wape, coverage_samples}
              - runner_upï¼šwMAPE æ¬¡ä¼˜ç®—æ³•ï¼Œè¾“å‡º {name, delta_wmape_pct_point = æ¬¡ä¼˜.wmape - æœ€ä¼˜.wmape}
              - overall_comment ä¸ recommendationsï¼šåŸºäºç›¸å¯¹å·®å¼‚ä¸è¦†ç›–æ ·æœ¬è‡ªåŠ¨ç”Ÿæˆ 3~5 æ¡å»ºè®®ï¼ˆä¸è¦å¤–æ˜¾æ¨ç†ï¼‰ã€‚

              Chartï¼ˆå›¾è¡¨ï¼‰
              - type: bar_horizontalï¼›metric: "wMAPE"ï¼›itemsï¼šæŒ‰ wMAPE å‡åºåˆ—å‡ºå„ç®—æ³• {algo, wmape}ï¼›tooltip_fieldsï¼šp50_wape/p90_wape/coverage_samplesã€‚

              Detail Tableï¼ˆæ˜ç»†è¡¨ï¼‰
              - columns: ["ç®—æ³•","wMAPE","P50 WAPE","P90 WAPE","è¦†ç›–æ ·æœ¬"]
              - rows: å„ç®—æ³•ä¸€è¡Œï¼Œæ•°å€¼ä¿ç•™ä¸¤ä½å°æ•°ã€‚

              Glossaryï¼ˆæœ¯è¯­è¡¨ï¼‰
              - wMAPEï¼šåŠ æƒå¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®ï¼Œè¶Šå°è¶Šå¥½ã€‚
              - P50 WAPEï¼šæ ·æœ¬è¯¯å·®çš„ä¸­ä½æ•°ï¼Œæ›´çœ‹ç¨³æ€è¡¨ç°ã€‚
              - P90 WAPEï¼š90% æ ·æœ¬è¯¯å·®ä¸è¶…è¿‡é˜ˆå€¼ï¼Œåæ˜ æç«¯å®¹é”™ã€‚
              - è¦†ç›–æ ·æœ¬ï¼šå‚ä¸è¯„ä¼°çš„ï¼ˆSKUÃ—ä»“Ã—å‘¨ï¼‰æ ·æœ¬æ•°ï¼Œè¶Šå¤§è¶Šç¨³å¥ã€‚

              Formattingï¼ˆæ ¼å¼åŒ–ï¼‰
              - æ•°å€¼ä¿ç•™ä¸¤ä½å°æ•°ï¼›æ—¥æœŸæŒ‰ YYYY-MM-DDï¼›generated_at ä½¿ç”¨ Asia/Shanghai å½“å¤©æ—¥æœŸï¼›ä¸è¿”å› CSV å¯¼å‡ºã€‚

              Output Specï¼ˆè¾“å‡ºè§„èŒƒï¼‰
              - ä¸¥æ ¼è¿”å›å¦‚ä¸‹ JSON ç»“æ„ï¼š
                {
                  "meta": {
                    "title": "éœ€æ±‚é¢„æµ‹ç®—æ³•è¯„æµ‹æ‘˜è¦ï¼ˆæ ¸å¿ƒæŒ‡æ ‡ï¼šwMAPEï¼‰",
                    "period": { "start_date": "YYYY-MM-DD", "end_date": "YYYY-MM-DD" },
                    "granularity": "week|month",
                    "sample": { "total_rows": <int>, "sku_count": <int>, "warehouse_count": <int> },
                    "generated_at": "YYYY-MM-DD"
                  },
                  "summary": {
                    "best_model": {"name":"MA","wmape":<num>,"p50_wape":<num>,"p90_wape":<num>,"coverage_samples":<int>},
                    "runner_up": {"name":"ETS","delta_wmape_pct_point":<num>},
                    "overall_comment": "...",
                    "recommendations": ["..."]
                  },
                  "chart": {"type":"bar_horizontal","metric":"wMAPE","items":[{"algo":"MA","wmape":<num>}],"tooltip_fields":["p50_wape","p90_wape","coverage_samples"]},
                  "detail_table": {"columns":["ç®—æ³•","wMAPE","P50 WAPE","P90 WAPE","è¦†ç›–æ ·æœ¬"],"rows":[{"algo":"MA","wmape":<num>,"p50_wape":<num>,"p90_wape":<num>,"coverage_samples":<int>}]},
                  "glossary": [{"term":"wMAPEï¼ˆåŠ æƒå¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®ï¼‰","desc":"åæ˜ æ•´ä½“ç²¾åº¦ï¼Œè¶Šå°è¶Šå¥½ã€‚"}]
                }

              CoTï¼ˆéšè—å¼æ¨ç†ï¼‰
              - å†…éƒ¨æµç¨‹ï¼šè§£æâ†’æ—¶é—´çª—æ˜ å°„â†’SQL å–æ•°â†’èšåˆä¸åˆ†ä½æ•°â†’æ’åºä¸é€‰æ‹©â†’æ ¼å¼åŒ–â†’è¾“å‡ºï¼›ä¸è¦å¤–æ˜¾æ¨ç†æˆ– SQLã€‚
        model:
          type: constant
          value:
            completion_params: {}
            mode: chat
            model: deepseek-chat
            model_type: llm
            provider: langgenius/deepseek/deepseek
            type: model-selector
        query:
          type: constant
          value: |
            {
              "intent": "{{#1762300000000.intent#}}",
              "time_window": "{{#1762300000000.time_window#}}",
              "granularity": "{{#1762300000000.granularity#}}",
              "warehouse": "{{#1762300000000.warehouse#}}",
              "SKU": "{{#1762300000000.SKU#}}",
              "algorithms": "{{#1762300000000.algorithms#}}",
              "metric": "{{#1762300000000.metric#}}",
              "sort_by": "{{#1762300000000.sort_by#}}",
              "query": "{{#1762300000000.query#}}"
            }
        tools:
          type: constant
          value:
          - enabled: true
            extra:
              description: |
                æ‰§è¡Œ DuckDB æŸ¥è¯¢ï¼Œå¹¶ä»¥ JSON å½¢å¼è¿”å›ç»“æœè¡Œã€‚

                - sql: å¾…æ‰§è¡Œçš„ SQL æ–‡æœ¬ã€‚
                - db_path: å¯é€‰çš„ .duckdb æ–‡ä»¶è·¯å¾„ï¼›ç¼ºçœæ—¶ä¼šåœ¨å¸¸è§ä½ç½®è‡ªåŠ¨æŸ¥æ‰¾ã€‚
                - limit: å¯é€‰çš„è¡Œæ•°é™åˆ¶ã€‚
                è¿”å›å€¼: {db, columns, rows, rowcount, duration_ms}
            parameters:
              db_path:
                auto: 1
                value: null
              limit:
                auto: 1
                value: null
              sql:
                auto: 1
                value: null
            provider_name: orchestrax-mcp
            provider_show_name: AIè°ƒæ‹¨MCP
            schemas:
            - form: llm
              label:
                zh_Hans: sql
              name: sql
              required: true
              type: string
            - form: llm
              label:
                zh_Hans: db_path
              name: db_path
              required: false
              type: string
            - form: llm
              label:
                zh_Hans: limit
              name: limit
              required: false
              type: string
            settings: {}
            tool_description: |
              æ‰§è¡Œ DuckDB æŸ¥è¯¢ï¼Œå¹¶ä»¥ JSON å½¢å¼è¿”å›ç»“æœè¡Œã€‚

              - sql: å¾…æ‰§è¡Œçš„ SQL æ–‡æœ¬ã€‚
              - db_path: å¯é€‰çš„ .duckdb æ–‡ä»¶è·¯å¾„ï¼›ç¼ºçœæ—¶ä¼šåœ¨å¸¸è§ä½ç½®è‡ªåŠ¨æŸ¥æ‰¾ã€‚
              - limit: å¯é€‰çš„è¡Œæ•°é™åˆ¶ã€‚
              è¿”å›å€¼: {db, columns, rows, rowcount, duration_ms}
            tool_label: duckdb_query
            tool_name: duckdb_query
            type: mcp
      height: 196
      id: '1762300001000'
      position:
        x: 380
        y: 280
      positionAbsolute:
        x: 380
        y: 280
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 260
    - data:
        selected: false
        title: ç»“æŸ
        type: end
        outputs:
        - value_selector:
          - '1762300001000'
          - text
          value_type: string
          variable: output
      height: 88
      id: '1762300002000'
      position:
        x: 680
        y: 280
      positionAbsolute:
        x: 680
        y: 280
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 240
    viewport:
      x: 80
      y: 120
      zoom: 0.9
  rag_pipeline_variables: []
